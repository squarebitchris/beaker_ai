# R2-E05-T003: Admin Entity Search

**Status:** ✅ Completed  
**Points:** 3  
**Epic:** E-005: Live Production (Admin Panel)  
**Priority:** P0  
**Completed:** December 2024

## Summary

Implemented unified search functionality for the admin panel, allowing admins to quickly locate Businesses, Users, Trials, and Calls by email, phone number, name, or ID during incident response. The search normalizes phone and email queries to match the database format, masks PII in results, and provides quick links to entity detail pages.

## Implementation Details

### Files Created

#### 1. `app/helpers/admin_helper.rb`
PII masking helper methods:
- `mask_email(email)` - Masks email to show only first character (e.g., `john@example.com` → `j***@example.com`)
- `mask_phone(phone)` - Masks phone to show last 4 digits (e.g., `+15551234567` → `***-***-4567`)

#### 2. `app/controllers/admin/search_controller.rb`
Main search controller with:
- `index` - Search action accepting `q` parameter
- `search_businesses(query)` - Search by name or stripe_customer_id (ILIKE), includes owners, limit 10
- `search_users(query)` - Search by normalized email (ILIKE), includes trials & businesses, limit 10
- `search_trials(query)` - Search by normalized phone_e164 or business_name (ILIKE), includes user, limit 10
- `search_calls(query)` - Search by to_e164, from_e164, or captured JSONB (ILIKE), includes callable, limit 10
- `normalize_phone(phone)` - Strip non-digits, add +1 prefix, return E.164 format
- `normalize_email(email)` - Lowercase, strip whitespace, remove +aliases

#### 3. `app/views/admin/search/index.html.erb`
Search UI with:
- Search form with autofocus input field
- Results grouped by entity type (Businesses, Users, Trials, Calls)
- PII masked in all results
- Clickable links to entity detail pages
- "No results" message when empty
- Sections only display when results exist
- Placeholder for future Lead model search (Phase 5)

#### 4. `spec/helpers/admin_helper_spec.rb`
Helper tests covering:
- Email masking for various formats
- Phone masking for E.164 and formatted numbers
- Edge cases (blank values, malformed inputs, single character local parts)

#### 5. `spec/requests/admin/search_spec.rb`
Request tests covering:
- Business search by name and stripe_customer_id
- User search by email (case-insensitive, normalized)
- Trial search by phone and business_name
- Call search by phone numbers
- PII masking in results
- Non-admin access control (redirect with alert)
- Empty query handling
- No results message

### Files Modified

#### 1. `app/views/layouts/admin.html.erb`
Added "Search" link to admin navigation sidebar between "Webhook Events" and "Businesses" links.

## Technical Implementation

### Phone Normalization Pattern

Reuses Trial model normalization pattern:
```ruby
digits = phone.to_s.gsub(/\D/, "")
digits = "1#{digits}" unless digits.start_with?("1")
"+#{digits}"
```

### Email Normalization Pattern

Reuses User model normalization pattern:
```ruby
email.to_s.strip.downcase.gsub(/\+.*@/, "@")
```

### Search Logic

Uses ILIKE for case-insensitive fuzzy matching across:
- **Businesses**: name, stripe_customer_id
- **Users**: email (normalized)
- **Trials**: phone_e164 (normalized), business_name
- **Calls**: to_e164, from_e164 (normalized), captured JSONB

Results limited to 10 per entity type for performance.

### Performance Optimizations

- Uses `.includes` to prevent N+1 queries
- Limits results to 10 per entity type
- Leverages existing database indexes on:
  - `users.email`
  - `businesses.stripe_customer_id`
  - `trials.phone_e164`
  - `calls.to_e164`, `calls.from_e164`

## Test Coverage

### Helper Specs (9 examples)
- All email masking scenarios
- All phone masking scenarios
- Edge case handling
- **Result: 9 examples, 0 failures**

### Request Specs (12 examples)
- All search functionality by entity type
- PII masking verification
- Access control enforcement
- Normalization verification
- **Result: 12 examples, 0 failures**

## Acceptance Criteria - Met

✅ Admin can search and find entities by email, phone, name, or ID  
✅ PII masked in all results (email shows j***@example.com, phone shows ***-***-4567)  
✅ Non-admins cannot access search (redirected with "Access denied" alert)  
✅ Phone queries normalized to E.164 format  
✅ Email queries normalized (lowercase, strip +aliases)  
✅ Results grouped by entity type  
✅ Quick links to entity detail pages  
✅ No N+1 queries (uses `.includes`)  
✅ Results limited to 10 per entity type  
✅ All specs passing (21 examples, 0 failures)  
✅ No linting errors  

## Security Considerations

- **PII Masking**: All email addresses and phone numbers masked in results to protect sensitive data
- **Access Control**: Admin-only access enforced at controller level via `Admin::BaseController`
- **Query Sanitization**: Uses parameterized queries via ILIKE to prevent SQL injection

## Future Enhancements

The following features are NOT in scope but noted for future consideration:

- **Autocomplete with debouncing** - Add Stimulus controller for typeahead functionality
- **Advanced search operators** - Support for exact match, date ranges, etc.
- **Full-text search** - Implement PostgreSQL full-text search for better performance
- **Lead search** - Add Lead model search when implemented in Phase 5
- **Single result redirect** - Auto-redirect when search returns exactly 1 result
- **Export results** - CSV export functionality for search results

## Dependencies

- **Requires:** Admin panel infrastructure (R2-E05-T001 completed)
- **Builds on:** Existing database indexes and normalization patterns
- **Future:** Will add Lead model search in Phase 5

## Files Changed Summary

**Created:** 5 files (1 helper, 1 controller, 1 view, 2 test files)  
**Modified:** 1 file (admin layout navigation)  
**Lines Added:** ~350 lines of code  
**Test Coverage:** 21 examples covering all search functionality  

## References

- Original Plan: `docs/ticket-breakdown.md` R2-E05-T003
- Related Tickets: R2-E05-T001 (Base admin interface), R2-E05-T002 (Webhook inspector)
- Admin Route Path: `/admin/search`
- Access URL: `/admin/search?q=<query>`


# R1-E03-T010: Upgrade CTA Placement + Tracking

**Status:** ✅ Completed  
**Points:** 2  
**Epic:** E-003: Webhook Processing & Conversion Driver  
**Completed:** October 26, 2025

## Overview

Implemented upgrade call-to-action (CTA) placement and tracking for Phase 2. The upgrade button in the mini-report now links to a placeholder route that shows a "Coming Soon" message, preparing for Phase 3 Stripe checkout integration.

## What Was Implemented

### 1. Upgrade Controller & Route

Created a new controller and route to handle upgrade intent from the mini-report:

**File:** `app/controllers/upgrades_controller.rb`

- Handles GET `/upgrade/:trial_id` requests
- Requires authentication via `before_action :authenticate_user!`
- Loads the trial from parameters
- Tracks upgrade intent server-side by logging to Rails.logger
- Stores trial ID and timestamp in session for Phase 3 conversion attribution

**File:** `config/routes.rb`

- Added route: `get "/upgrade/:trial_id", to: "upgrades#new", as: :new_upgrade`
- Placed after trials resource, before webhook endpoints
- Includes comment indicating Phase 2 placeholder / Phase 3 Stripe checkout

### 2. Upgrade View (Coming Soon Placeholder)

**File:** `app/views/upgrades/new.html.erb`

Created a mobile-optimized placeholder page that:
- Displays "Upgrade Coming Soon" message with lightning bolt icon
- Lists benefits: dedicated phone number, unlimited inbound calls, automatic lead capture, real-time dashboard
- Provides "Back to Trial" button to return to trial page
- Uses existing ViewComponent (Primitives::CardComponent)
- Designed mobile-first with proper spacing and typography

### 3. CallCard Component Update

**File:** `app/components/voice/call_card_component/call_card_component.html.erb`

Updated the upgrade CTA link:
- Changed from `link_to "#"` to `link_to new_upgrade_path(trial_id: call_record.callable_id)`
- Passes trial context via URL parameter
- Maintains all existing analytics tracking attributes

### 4. Analytics Controller Enhancement

**File:** `app/javascript/controllers/analytics_controller.js`

Enhanced tracking to include trial context:
- Added `trialId` to static values
- Updated `trackUpgradeClick` to log trial ID to console
- Stores trial ID in localStorage for Phase 3 conversion attribution
- Maintains backward compatibility with call_id tracking

### 5. Test Coverage

**Files Created:**
- `spec/requests/upgrades_spec.rb` - Request spec for upgrade controller
- `spec/system/upgrade_cta_spec.rb` - System spec for end-to-end flow

**File Updated:**
- `spec/components/voice/call_card_component_spec.rb` - Added tests for trial_id attribute and link href

**Test Cases:**
- ✅ Request spec: authenticated users see coming soon page
- ✅ Request spec: session tracking works correctly
- ✅ Request spec: upgrade intent is logged
- ✅ Request spec: unauthenticated users redirected to sign in
- ✅ Component spec: CTA has correct tracking attributes including trial_id
- ✅ Component spec: CTA links to correct upgrade URL
- ✅ System spec: end-to-end navigation from trial page to upgrade page

### 6. Factory Fix

**File:** `spec/factories/calls.rb`

Fixed syntax in `:with_captured_lead` trait from `do...end` block to hash literal to properly initialize the `captured` JSONB column.

## Technical Decisions

### Why Server-Side + Client-Side Tracking?

**Server-Side (Session):**
- Immediate logging to Rails.logger for debugging
- Session storage for conversion attribution in Phase 3
- Cannot be blocked by ad blockers or disabled JavaScript

**Client-Side (localStorage):**
- A/B testing capability (can track variants)
- Survives page refreshes
- Accessible via JavaScript for analytics integration

### Why "Coming Soon" Placeholder?

Rather than linking to a dead `#` URL or showing an error:
- Provides clear expectation setting for users
- Lists benefits to build anticipation
- Can be easily replaced with Stripe checkout redirect in Phase 3
- Maintains professional appearance

### Why Pass trial_id in URL?

- Phase 3 migration: can extract from URL or use session[:upgrade_intent]
- RESTful routing pattern
- Enables direct linking to specific trials
- No need for POST requests

## Acceptance Criteria Status

- [x] Upgrade CTA links to `/upgrade/:trial_id` route
- [x] Unauthenticated users redirected to sign in
- [x] Authenticated users see "Coming soon" message
- [x] Server-side tracking logs upgrade intent
- [x] Session stores trial_id and timestamp for Phase 3
- [x] Client-side localStorage continues to track clicks
- [x] All tests pass (request, component, system)
- [x] Manual testing confirms flow works end-to-end

## Phase 3 Migration Path

When implementing Stripe checkout (R2-E04-T003):

1. **UpgradesController#new:**
   ```ruby
   def new
     @trial = Trial.find(params[:trial_id])
     track_upgrade_intent(@trial)
     
     # Redirect to Stripe checkout
     checkout_session = StripeClient.new.create_checkout_session(
       trial_id: @trial.id,
       plan: "starter"
     )
     redirect_to checkout_session.url
   end
   ```

2. **Remove:** `app/views/upgrades/new.html.erb` (no longer needed)

3. **Keep:**
   - `session[:upgrade_intent]` for conversion attribution
   - Client-side localStorage tracking for A/B testing
   - All analytics tracking attributes

## Files Modified

### Created (3 files):
- `app/controllers/upgrades_controller.rb`
- `app/views/upgrades/new.html.erb`
- `spec/requests/upgrades_spec.rb`
- `spec/system/upgrade_cta_spec.rb`

### Modified (5 files):
- `config/routes.rb` - Added upgrade route
- `app/components/voice/call_card_component/call_card_component.html.erb` - Updated CTA link
- `app/javascript/controllers/analytics_controller.js` - Added trialId tracking
- `spec/components/voice/call_card_component_spec.rb` - Added tests for trial_id and href
- `spec/factories/calls.rb` - Fixed :with_captured_lead trait syntax

## Test Results

**Total Tests:** 507 examples, 0 failures  
**Coverage:** 91.23% (947 / 1038 lines)  
**Linting:** ✅ All corrections applied  
**CI Status:** ✅ Passing

## Manual Testing

1. Create a trial and complete a call
2. Visit trial show page (`/trials/:id`)
3. Click "Go Live - Get Your Number" button in call card
4. ✅ Redirected to `/upgrade/:trial_id`
5. ✅ See "Upgrade Coming Soon" message
6. ✅ Click "Back to Trial" returns to trial page
7. ✅ Check localStorage: upgrade_clicks array contains trial_id
8. ✅ Check Rails logs: upgrade intent logged
9. ✅ Check session: upgrade_intent hash contains trial_id and timestamp

## Related Tickets

- **R1-E03-T006** - CallCard ViewComponent (prerequisite)
- **R1-E03-T009** - Mini-report UI (where CTA appears)
- **R2-E04-T003** - Checkout session endpoint (Phase 3 migration)
- **R2-E04-T011** - Upgrade button in trial UI (companion ticket)

## References

- start.md: Section 2 (Phase 2), Section 9.5 (Analytics tracking)
- BUILD-GUIDE.md: Section 4.2 (Mini-report as conversion driver)
- ticket-breakdown.md: R1-E03-T010 details


# R1-E03-T012: Race Condition Prevention - COMPLETED ✅

**Status:** ✅ COMPLETED  
**Points:** 3  
**Date:** January 26, 2025

## Summary

Race condition prevention is already implemented using database-level unique constraints combined with application-level idempotency patterns. No additional `with_lock` calls are needed as the current implementation is sufficient.

## Implementation Details

### 1. Database Constraints
**File:** `db/schema.rb` (line 79)

Unique partial index prevents duplicate Call records:
```ruby
t.index ["vapi_call_id"], name: "index_calls_on_vapi_call_id", 
        unique: true, where: "(vapi_call_id IS NOT NULL)"
```

### 2. Application-Level Idempotency
**File:** `app/services/webhooks/vapi/call_processor.rb` (lines 30-86)

Uses `find_or_initialize_by` with `ActiveRecord::RecordNotUnique` rescue:
```ruby
call = Call.find_or_initialize_by(vapi_call_id: vapi_call_id)

if call.new_record?
  call.assign_attributes(...)
  
  begin
    call.save!
    trial.increment!(:calls_used)
  rescue ActiveRecord::RecordNotUnique
    # Another worker already processed this - don't increment
    call = Call.find_by(vapi_call_id: vapi_call_id)
  end
end
```

### 3. Webhook Event Idempotency
**File:** `db/schema.rb` (line 176)

Unique constraint prevents duplicate webhook processing:
```ruby
t.index ["provider", "event_id"], name: "idx_unique_webhook_event", unique: true
```

## Technical Decisions

### Why No `with_lock`?

**Decision:** Use database constraints + RecordNotUnique rescue pattern instead of pessimistic locking

**Rationale:**
- Database-level uniqueness is atomic and fastest
- `with_lock` would serialize webhook processing, reducing throughput
- Current pattern handles races gracefully without blocking
- Reduces lock contention on Trial records

**Trade-off:** Accepts that duplicate webhook deliveries may trigger redundant job executions, but ensures only one Call record is created

### Model Validations
**File:** `app/models/call.rb` (line 9)

```ruby
validates :vapi_call_id, uniqueness: true, allow_nil: true
```

Application-level validation provides early feedback before database constraint.

## Testing

Existing tests verify idempotency:
- `spec/services/webhooks/vapi/call_processor_spec.rb` includes race condition tests
- Database constraint violations are handled gracefully
- Duplicate webhook events return 200 OK without reprocessing

## Exit Criteria (All Met)

- ✅ Unique constraints on vapi_call_id and twilio_call_sid
- ✅ Webhook event idempotency via (provider, event_id) constraint
- ✅ Graceful handling of RecordNotUnique exceptions
- ✅ Atomic counter increments (only on successful insert)
- ✅ Test coverage for concurrent webhook processing
- ✅ No duplicate Call records created under race conditions

## Related Tickets

- R1-E01-T006: Webhook receiver framework with idempotency
- R1-E03-T002: ProcessVapiEventJob implementation


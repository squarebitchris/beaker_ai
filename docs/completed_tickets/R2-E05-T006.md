# R2-E05-T006: Call Model for Paid Calls - COMPLETED ✅

**Status:** ✅ COMPLETED  
**Points:** 3  
**Date:** October 26, 2025  
**Epic:** E-005: Live Production (Phase 4)

## Summary

Extended the existing polymorphic `Call` model with `lead_id` support for future Phase 5 lead linking functionality. The Call model already supported both Trial and Business calls via polymorphic associations, requiring only the addition of the `lead_id` field.

## Context & Why This Matters

R2-E05-T006 is part of Phase 4's paid product functionality. The existing polymorphic Call model (`callable_type`/`callable_id`) already worked for both Trial and Business calls. The only missing piece was the `lead_id` field needed for Phase 5 when calls are created from lead forms and need to be linked back to their originating leads.

### Key Decision: Keep Polymorphic Pattern

**Decision:** Extend existing polymorphic Call model rather than creating separate tables

**Rationale:**
- Single table for all call types (Trial + Business) avoids duplication
- Polymorphic pattern already proven to work (tests pass for Business calls)
- Query efficiency with composite index on `[callable_type, callable_id, created_at]`
- DRY principle: both trial and business calls share same captured data structure
- Phase 2 fields (`captured`, `scenario_slug`) work for both call types

## Implementation

### 1. Migration: Added lead_id Column ✅

**File:** `db/migrate/20251026215629_add_lead_id_to_calls.rb`

```ruby
class AddLeadIdToCalls < ActiveRecord::Migration[8.1]
  def change
    add_reference :calls, :lead, null: true, foreign_key: false, type: :uuid, index: true
  end
end
```

**Key Details:**
- `null: true` - Lead association is optional since it doesn't exist yet
- `foreign_key: false` - Foreign key constraint will be added in Phase 5 when Lead model exists
- `type: :uuid` - Matches primary key type for consistency
- `index: true` - Indexed for efficient lead lookups in Phase 5

**Migration Output:**
```
== 20251026215629 AddLeadIdToCalls: migrating =================================
-- add_reference(:calls, :lead, {null: true, foreign_key: false, type: :uuid, index: true})
   -> 0.0063s
== 20251026215629 AddLeadIdToCalls: migrated (0.0063s) ========================
```

### 2. Call Model - Prepared for Phase 5 ✅

**File:** `app/models/call.rb`

Added commented association that will be uncommented in Phase 5:

```ruby
class Call < ApplicationRecord
  belongs_to :callable, polymorphic: true
  # belongs_to :lead, optional: true  # Uncomment in Phase 5 when Lead model exists

  # ... rest of model unchanged
end
```

**Why Commented:** The Lead model doesn't exist yet (Phase 5). ActiveRecord would throw `NameError: uninitialized constant Lead` if we tried to use the association now. Adding it as a comment with a clear Phase 5 note ensures it's ready when needed.

### 3. Factory Trait: with_lead ✅

**File:** `spec/factories/calls.rb`

Added trait for future use when Lead model exists:

```ruby
trait :with_lead do
  # Association will be defined when Lead model exists in Phase 5
  # For now, lead_id can be set to a UUID string for testing
  lead_id { SecureRandom.uuid }
end
```

**Purpose:** Provides a way to test calls with lead_id without requiring the Lead model to exist.

### 4. Model Specs: Lead Association Tests ✅

**File:** `spec/models/call_spec.rb`

Added tests for lead_id field:

```ruby
describe 'lead association' do
  it 'accepts lead_id without requiring Lead model' do
    call = build(:call, lead_id: nil)
    expect(call.lead_id).to be_nil
    expect(call).to be_valid
  end

  it 'accepts lead_id with a UUID string' do
    lead_uuid = SecureRandom.uuid
    call = build(:call, lead_id: lead_uuid)
    expect(call.lead_id).to eq(lead_uuid)
    expect(call).to be_valid
  end
end
```

**Results:** All 25 Call model specs pass ✅

## What Was NOT Changed

The following were **intentionally left unchanged** because they already worked correctly:

- ✅ Polymorphic associations (`belongs_to :callable`) - Already supported Business calls
- ✅ Call scopes (`for_business`, `for_trial`) - Already working correctly  
- ✅ Phase 2 fields (`captured`, `scenario_slug`) - Already work for both call types
- ✅ Cost tracking fields (`vapi_cost`, `twilio_cost`, `openai_cost`) - Already functional
- ✅ Status enums (initiated, ringing, in_progress, completed, failed) - No changes needed
- ✅ Direction enums (inbound, outbound_trial, outbound_lead) - No changes needed
- ✅ All existing validations and helper methods - All work as expected

## Testing Results

### Call Model Specs
```
25 examples, 0 failures
Finished in 0.367 seconds
```

### Linting
✅ No linter errors

### Manual Verification
```bash
$ bin/rails runner "b = Business.create!(name: 'Test', stripe_customer_id: 'cus_test', plan: 'starter'); c = Call.create!(callable: b, direction: 'inbound', to_e164: '+15551234567'); puts c.callable_type; puts b.calls.count"
Business
1
```

Result: Business calls work perfectly with polymorphic pattern ✅

## Schema Changes

**Before:**
```ruby
create_table :calls, id: :uuid do |t|
  t.uuid "callable_id"
  t.string "callable_type"
  # ... other fields ...
end
```

**After:**
```ruby
create_table :calls, id: :uuid do |t|
  t.uuid "callable_id"
  t.string "callable_type"
  t.uuid "lead_id", null: true  # NEW
  t.index ["lead_id"]  # NEW
  # ... other fields ...
end
```

## Files Changed

1. `db/migrate/20251026215629_add_lead_id_to_calls.rb` - New migration
2. `app/models/call.rb` - Added commented lead association
3. `spec/factories/calls.rb` - Added `:with_lead` trait
4. `spec/models/call_spec.rb` - Added lead association tests
5. `db/schema.rb` - Updated by migration (auto-generated)

## Exit Criteria - All Met ✅

- [x] Migration runs without errors
- [x] Schema updated with `lead_id` column
- [x] `Call.new(callable: business)` works
- [x] `business.calls` returns Call records
- [x] All existing Call specs still pass (25 examples, 0 failures)
- [x] No regression in Phase 2 trial call functionality
- [x] Ready for R2-E05-T007 (Paid Webhook Processing)

## Next Steps

**Phase 5 (Speed-to-Lead):** When the Lead model is created, uncomment the `belongs_to :lead, optional: true` association in `app/models/call.rb` and add the foreign key constraint to the migration.

**Phase 4 Next Ticket:** R2-E05-T007 - Paid webhook processing (extend `ProcessVapiEventJob` to handle Business calls)

## Related Tickets

- **R1-E01-T004** - Created original Call model with polymorphic support
- **R1-E03-T005** - Added Phase 2 fields (captured, scenario_slug) to Call model
- **R2-E05-T007** - Next ticket: Paid webhook processing
- **R3-E08-T008** - Future: Link calls to leads (Phase 5)

## Lessons Learned

1. **Polymorphic associations are powerful** - Single Call model handles both Trial and Business calls elegantly
2. **Forward-thinking migrations** - Adding `lead_id` now prevents future breaking migrations in Phase 5
3. **Optional fields matter** - Making `lead_id` nullable allows existing code to work without errors
4. **Clear commenting** - Commented associations with notes about future phases make intent clear

## Technical Notes

- Polymorphic design means calls table has `callable_type` ('Trial' or 'Business') and `callable_id` (uuid)
- No need for separate `trial_calls` and `business_calls` tables
- Lead linking will be implemented in Phase 5 when Lead model exists
- Foreign key constraint will be added in Phase 5 migration when creating Lead model


# R1-E02-T009: SignupsController (email + marketing consent)

**Epic:** E-002: Trial Flow  
**Points:** 3  
**Priority:** P0  
**Completed:** October 25, 2025

## Overview

Implemented a complete signup flow with email capture, marketing consent tracking, and magic link authentication. This ticket establishes the entry point for the trial experience, allowing prospects to sign up and receive personalized AI phone agents.

## Implementation Summary

### Core Features Implemented

1. **SignupsController** (`app/controllers/signups_controller.rb`)
   - Email normalization (strip whitespace, lowercase)
   - Email format validation with regex pattern
   - Marketing consent capture and tracking
   - User creation/finding with `find_or_initialize_by`
   - EmailSubscription creation with consent metadata
   - Magic link sending via Devise passwordless
   - Comprehensive error handling with Sentry integration
   - IP and User-Agent tracking for compliance

2. **EmailSubscription Model** (`app/models/email_subscription.rb`)
   - Email uniqueness validation (case-insensitive)
   - Marketing consent boolean validation
   - Source tracking (trial_signup, landing_page, etc.)
   - Consent metadata (IP, User-Agent, timestamp)
   - Scopes for opted-in users and by source
   - Optional user association

3. **Mobile-First UI** (`app/views/signups/new.html.erb`)
   - Responsive design with Tailwind CSS
   - ViewComponents integration (Card, Input, Button)
   - Professional landing page design
   - Marketing consent checkbox
   - Accessibility features (proper labels, ARIA attributes)

4. **Database Schema** (`db/migrate/20251026030343_create_email_subscriptions.rb`)
   - UUID primary keys
   - Case-insensitive email field (citext)
   - Marketing consent boolean
   - Source tracking
   - Consent metadata fields
   - Proper indexes for performance

## Technical Details

### Email Validation
```ruby
# Regex pattern for email validation
/\A[\w+\-.]+@[a-z\d\-]+(\.[a-z\d\-]+)*\.[a-z]+\z/i
```

**Validates:**
- ✅ `test@example.com`
- ✅ `user.name@domain.co.uk`
- ✅ `test+tag@example.com`
- ❌ `invalid-email`
- ❌ `test@`
- ❌ `@example.com`

### Magic Link Integration
- Uses Devise passwordless gem
- 20-minute token expiration
- Paranoid mode (doesn't reveal if email exists)
- Automatic session creation on link click

### Consent Tracking
- IP address capture for compliance
- User-Agent tracking
- Timestamp of consent
- Source attribution (trial_signup)

## Test Coverage

### Request Specs (10 tests)
- ✅ Form rendering
- ✅ Valid signup with consent
- ✅ Valid signup without consent
- ✅ Invalid email format rejection
- ✅ Missing email handling
- ✅ Existing user handling
- ✅ Email normalization
- ✅ Magic link email sending
- ✅ Consent metadata tracking
- ✅ Error handling

### Model Specs (12 tests)
- ✅ EmailSubscription validations
- ✅ Email uniqueness enforcement
- ✅ Email normalization
- ✅ Scopes (opted_in, by_source)
- ✅ User associations
- ✅ Default value setting

### System Specs (6 tests)
- ✅ End-to-end signup flow
- ✅ Marketing consent handling
- ✅ Invalid email error display
- ✅ Existing user handling
- ✅ Mobile responsiveness (375px)
- ✅ Accessibility compliance

**Total: 28 tests, all passing**

## Security & Compliance

### Data Protection
- Email normalization prevents duplicate accounts
- Case-insensitive uniqueness constraints
- Proper validation at both model and controller levels

### Consent Tracking
- IP address logging for audit trails
- User-Agent capture for compliance
- Explicit consent boolean tracking
- Source attribution for marketing compliance

### Error Handling
- Sentry integration for monitoring
- Graceful error messages
- No information leakage about user existence

## Performance & UX

### Mobile Optimization
- Responsive design tested at 375px
- Touch-friendly form elements
- Fast loading with ViewComponents
- No horizontal scroll issues

### User Experience
- Clear value proposition ("Call hot leads in 60 seconds")
- Simple, single-step signup
- Immediate feedback on errors
- Professional, trustworthy design

## Files Modified

### New Files
- `app/controllers/signups_controller.rb` - Main controller logic
- `app/models/email_subscription.rb` - Consent tracking model
- `app/views/signups/new.html.erb` - Signup form view
- `db/migrate/20251026030343_create_email_subscriptions.rb` - Database schema
- `spec/requests/signups_spec.rb` - Request tests
- `spec/models/email_subscription_spec.rb` - Model tests
- `spec/system/trial_signup_spec.rb` - System tests
- `spec/factories/email_subscriptions.rb` - Test factories

### Modified Files
- `config/routes.rb` - Added signup routes
- `app/models/user.rb` - Added email_subscriptions association
- `README.md` - Updated ticket status

## Definition of Done ✅

- [x] Request specs passing (10 specs)
- [x] Mailer enqueued (tested)
- [x] Mobile form verified at 375px (system spec)
- [x] Invalid email format rejected
- [x] Email normalization working
- [x] Marketing consent tracking
- [x] Error handling with Sentry
- [x] All linting issues resolved
- [x] 95.98% test coverage maintained

## Quality Metrics

- **Test Coverage:** 95.98% line coverage
- **Test Count:** 298 total tests, all passing
- **Linting:** 0 RuboCop offenses
- **Security:** Brakeman clean (0 warnings)
- **Performance:** Mobile-optimized, fast loading

## Next Steps

This ticket completes the signup foundation. The next logical tickets would be:

1. **R1-E02-T007** - Trial status page with ready polling
2. **R1-E02-T008** - "Call Me Now" button + phone input UI
3. **R1-E02-T012** - Trial abuse prevention (rate limiting, etc.)

The signup flow is now production-ready and provides a solid foundation for the trial experience.
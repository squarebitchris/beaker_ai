# R2-E05-T004: Twilio Client Setup + Number Provisioning

**Ticket ID:** R2-E05-T004  
**Epic:** E-005: Live Production  
**Points:** 4  
**Status:** ✅ Complete  
**Completed:** January 27, 2025

---

## Overview

This ticket completes the Twilio integration foundation by adding the `PhoneNumber` model and extending the `TwilioClient` with webhook configuration capabilities. This enables the next ticket (R2-E05-T005: AssignTwilioNumberJob) to provision dedicated phone numbers for paid businesses.

---

## Implementation Summary

### 1. PhoneNumber Model Created

**Files Created:**
- `app/models/phone_number.rb` - PhoneNumber model with validations and associations
- `db/migrate/20251026213937_create_phone_numbers.rb` - Migration for phone_numbers table
- `spec/factories/phone_numbers.rb` - FactoryBot factory for testing
- `spec/models/phone_number_spec.rb` - Comprehensive model specs

**Model Features:**
```ruby
class PhoneNumber < ApplicationRecord
  belongs_to :business
  
  validates :e164, :twilio_sid, presence: true
  validates :e164, uniqueness: { case_sensitive: false }, format: { with: /\A\+1\d{10}\z/ }
  validates :twilio_sid, uniqueness: { case_sensitive: true }
  
  scope :active, -> { joins(:business).where(businesses: { status: :active }) }
  
  def formatted
    # Returns (XXX) XXX-XXXX format
    digits = e164.gsub(/\D/, "")
    "(#{digits[1..3]}) #{digits[4..6]}-#{digits[7..10]}"
  end
end
```

**Database Schema:**
- UUID primary key
- `business_id` foreign key (UUID, indexed)
- `e164` phone number string (unique index, case-insensitive)
- `twilio_sid` Twilio identifier (unique index)
- `country` (default: 'US')
- `area_code` string
- `capabilities` JSONB field for voice/SMS capabilities
- Timestamps

### 2. Business Model Updated

**File Modified:** `app/models/business.rb`

**Changes:**
1. Uncommented `has_one :phone_number` association
2. Added `has_phone_number?` helper method

```ruby
has_one :phone_number, dependent: :destroy

def has_phone_number?
  phone_number.present?
end
```

**Specs Updated:** `spec/models/business_spec.rb`
- Added specs for phone_number association
- Added specs for `has_phone_number?` helper method

### 3. TwilioClient Extended

**File Modified:** `app/services/twilio_client.rb`

**New Method Added:** `update_number_webhook`

```ruby
def update_number_webhook(number_sid:, voice_url:)
  with_circuit_breaker(name: "twilio:update_number_webhook") do
    with_retry(attempts: 3) do
      payload = {
        "VoiceUrl" => voice_url,
        "VoiceMethod" => "POST",
        "StatusCallback" => ENV.fetch("TWILIO_STATUS_CALLBACK_URL", ""),
        "StatusCallbackMethod" => "POST"
      }
      
      response = make_request(:post, "/Accounts/#{@account_sid}/IncomingPhoneNumbers/#{number_sid}.json", payload)
      
      raise ApiError, "Twilio update error: #{response.code}" unless (200..299).include?(response.code.to_i)
      
      JSON.parse(response.body)
    end
  end
end
```

**Features:**
- Circuit breaker protection (`twilio:update_number_webhook`)
- Automatic retry with exponential backoff (3 attempts)
- Configurable voice URL for inbound calls
- Status callback URL for call status updates

**Specs Added:** `spec/services/twilio_client_spec.rb`
- Success case: updates voice URL and returns response
- Failure case: raises ApiError on API failure

### 4. Environment Variables Documented

**File Modified:** `env.example`

Added documentation comment for `TWILIO_VOICE_URL`:
```bash
# Twilio Voice URL (for inbound calls - connects to Vapi)
TWILIO_VOICE_URL=http://localhost:3000/voice
```

---

## Testing

### Model Specs
- ✅ PhoneNumber associations (belongs_to :business)
- ✅ PhoneNumber validations (presence, uniqueness, E.164 format)
- ✅ PhoneNumber#formatted method
- ✅ PhoneNumber scopes (active businesses)
- ✅ Business phone_number association
- ✅ Business#has_phone_number? helper

### Service Specs
- ✅ TwilioClient#update_number_webhook success case
- ✅ TwilioClient#update_number_webhook failure case (404)
- ✅ Existing TwilioClient methods still pass (make_call, get_call, provision_number, send_sms)

### Results
```
52 examples, 0 failures
```

**Coverage:** All new code covered by specs.

---

## Integration with Existing Code

### Dependencies Satisfied
- ✅ TwilioClient already had `provision_number()` method
- ✅ Circuit breakers configured via ApiClientBase
- ✅ Retry logic inherited from ApiClientBase
- ✅ Webhook infrastructure in place (from Phase 2)

### Next Steps Enabled
This ticket enables **R2-E05-T005: AssignTwilioNumberJob** which will:
1. Purchase Twilio number via `provision_number()`
2. Configure webhook via `update_number_webhook()`
3. Create PhoneNumber record
4. Associate with Business
5. Broadcast to BusinessChannel

---

## Technical Decisions

### 1. Case-Insensitive E.164 Uniqueness
Phone numbers are normalized to E.164 format, so uniqueness validation is case-insensitive to prevent duplicates like `+15551234567` vs `+15551234567` (identical).

### 2. Capabilities JSONB Field
Stored as JSONB for flexibility - Twilio can add new capabilities without migration:
```json
{
  "voice": true,
  "sms": true,
  "mms": false
}
```

### 3. Area Code Extraction
Area code extracted from E.164 for easier filtering/searching:
```ruby
area_code { e164[2..4] }  # Extract from +15551234567
```

### 4. Helper Method Instead of Attribute
`has_phone_number?` is a query method, not a database column, to avoid N+1 queries when checking presence across many businesses.

---

## Files Changed

**New Files:**
1. `app/models/phone_number.rb`
2. `db/migrate/20251026213937_create_phone_numbers.rb`
3. `spec/factories/phone_numbers.rb`
4. `spec/models/phone_number_spec.rb`

**Modified Files:**
1. `app/models/business.rb` - Added phone_number association and helper
2. `app/services/twilio_client.rb` - Added update_number_webhook method
3. `spec/models/business_spec.rb` - Added phone_number specs
4. `spec/services/twilio_client_spec.rb` - Added update_number_webhook specs
5. `env.example` - Added TWILIO_VOICE_URL documentation
6. `db/schema.rb` - Updated with phone_numbers table

---

## Exit Criteria Met

✅ PhoneNumber model created with validations and associations  
✅ Migration adds phone_numbers table with proper indexes  
✅ TwilioClient has `update_number_webhook()` method with circuit breaker  
✅ Business model has phone_number association  
✅ All specs pass (52 examples, 0 failures)  
✅ No linter errors (Rubocop clean)  
✅ ENV vars documented  

---

## References

- **Ticket:** R2-E05-T004
- **Dependencies:** None (foundation ticket)
- **Enables:** R2-E05-T005 (AssignTwilioNumberJob)
- **Related Tickets:** All Phase 4 tickets in R2-E05-* series


# R1-E01-T001: Rails Foundation Setup

**Status:** ✅ Completed  
**Points:** 2  
**Epic:** E-001 Foundations  
**Priority:** P0  

## Overview

Successfully configured the Rails 8.1 application foundation with PostgreSQL UUIDs, RSpec testing infrastructure, and health check endpoint. Initially used Rails 8 defaults (SolidQueue) but later migrated to Sidekiq for better production stability.

## What Was Implemented

### 1. RSpec Testing Infrastructure
- **Switched from Minitest to RSpec**: Removed `test/` directory and installed RSpec
- **Added Testing Gems**: 
  - `rspec-rails` (~> 6.1) - Core RSpec framework
  - `factory_bot_rails` - Test data factories
  - `faker` - Fake data generation
  - `shoulda-matchers` - Rails-specific matchers
  - `webmock` - HTTP request stubbing
  - `vcr` - HTTP interaction recording
- **Created Support Files**:
  - `spec/support/factory_bot.rb` - FactoryBot configuration
  - `spec/support/shoulda_matchers.rb` - Shoulda matchers setup
  - `spec/support/vcr.rb` - VCR configuration with sensitive data filtering
- **Configured RSpec**: Updated `spec/rails_helper.rb` to auto-load support files

### 2. PostgreSQL UUID Support
- **Created Migration**: `db/migrate/20251025215817_enable_uuid.rb` to enable `pgcrypto` extension
- **Configured Generators**: Updated `config/application.rb` to use UUID primary keys by default
- **Applied Migration**: Successfully enabled UUID support in development and test databases

### 3. Development Tools
- **Bullet**: Added N+1 query detection (configured in `config/environments/development.rb`)
- **Letter Opener**: Email preview in development environment
- **Annotate**: Schema comments (has Ruby 3.4 compatibility issue, but not blocking)

### 4. Health Check Endpoint
- **Controller**: Created `app/controllers/health_controller.rb` with `/up` endpoint
- **Route**: Updated `config/routes.rb` to map `/up` to health controller
- **Response**: Returns JSON with system status:
  ```json
  {
    "status": "ok",
    "db": true,
    "queue": true
  }
  ```
- **Test**: Created `spec/requests/health_spec.rb` to verify endpoint behavior

### 5. Background Jobs Configuration
- **Initially**: Ran `rails solid_queue:install` to set up queue infrastructure
- **Later Migrated**: Switched to Sidekiq for better production stability and community support
- **Health Check**: Updated to verify background job system availability

### 6. Configuration Updates
- **Bullet**: Configured for N+1 detection in development
- **Letter Opener**: Set as mail delivery method in development
- **RSpec**: Configured `.rspec` with documentation format and colors
- **Environment**: Added email delivery configuration

## Files Modified

### Core Files
- `Gemfile` - Added RSpec, testing, and development gems
- `config/application.rb` - Added UUID generator configuration
- `config/environments/development.rb` - Added Bullet and Letter Opener config
- `config/routes.rb` - Added health check route

### New Files Created
- `db/migrate/20251025215817_enable_uuid.rb` - UUID extension migration
- `app/controllers/health_controller.rb` - Health check controller
- `spec/support/factory_bot.rb` - FactoryBot configuration
- `spec/support/shoulda_matchers.rb` - Shoulda matchers configuration
- `spec/support/vcr.rb` - VCR configuration
- `spec/requests/health_spec.rb` - Health check test

### Files Removed
- `test/` directory - Removed Minitest infrastructure

## Verification Results

### ✅ All Exit Criteria Met
- **bin/dev boots**: Successfully starts Puma on port 3000 with JS/CSS watchers
- **Database creation**: Databases already existed, migrations applied successfully
- **Tailwind CSS**: Compiles successfully (CSS watcher started)
- **UUID support**: pgcrypto extension enabled and working
- **Health check**: Returns 200 with proper JSON response
- **RSpec**: 1 example, 0 failures (health check spec passing)
- **Rubocop**: 30 files inspected, no offenses detected

### Test Results
```bash
Health Check
  GET /up
    returns successful health status

Finished in 0.02582 seconds (files took 0.60484 seconds to load)
1 example, 0 failures
```

### Linting Results
```bash
30 files inspected, no offenses detected
```

## Technical Decisions

### Rails 8.1 Background Jobs
- **Migrated to Sidekiq**: After initial Phase 0 deployment, switched from SolidQueue to Sidekiq
- **Rationale**: Better production stability, more mature ecosystem, better monitoring tools
- **Impact**: Requires Redis addon on Heroku (~$3/month for mini plan)

### UUID Primary Keys
- **Enabled globally**: All future models will use UUID primary keys by default
- **Migration**: Used `pgcrypto` extension for UUID generation
- **Compatibility**: Works with Rails 8.1 and PostgreSQL

### Testing Strategy
- **RSpec over Minitest**: Better ecosystem and matches ticket specifications
- **FactoryBot**: For test data generation instead of fixtures
- **VCR**: For HTTP interaction recording (prepared for future API integrations)

## Next Steps

The foundation is now ready for:
- **R1-E01-T002**: Configure Devise + Passwordless gem for magic-link auth
- **R1-E01-T003**: Background jobs now use Sidekiq (migrated from SolidQueue)
- **R1-E01-T004**: Create base models (User, Trial, Assistant, Call, Business)

## Environment Setup

To replicate this setup:
1. Run `bundle install` to install new gems
2. Run `rails generate rspec:install` to initialize RSpec
3. Run `bin/rails db:migrate` to apply migrations
4. Run `bundle exec rspec` to verify tests pass
5. Run `bundle exec rubocop` to verify linting passes

## Notes

- **Annotate Gem**: Has Ruby 3.4 compatibility issue but doesn't block functionality
- **Environment Variables**: `.env.example` should be created manually (blocked by gitignore)
- **Background Jobs**: Migrated from SolidQueue to Sidekiq for better production stability

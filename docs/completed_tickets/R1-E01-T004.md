# R1-E01-T004: Create Base Models - COMPLETED ✅

**Epic:** E-001: Rails Foundation & Infrastructure  
**Points:** 5  
**Priority:** P0  
**Dependencies:** R1-E01-T001  
**Completed:** October 25, 2025

## Overview

Successfully created all core domain models (User, Trial, Call, Business, BusinessOwnership) with proper migrations, associations, validations, enums, scopes, callbacks, and comprehensive test coverage. This establishes the foundation for the entire Beaker AI application.

## What Was Implemented

### 1. User Model Updates

**Migration:** `db/migrate/20251025225442_add_fields_to_users.rb`
- Added `admin` boolean column (default: false, null: false)
- Added partial index on `admin` where admin = true

**Model:** `app/models/user.rb`
- Added associations: `has_many :trials`, `has_many :business_ownerships`, `has_many :businesses`
- Added scope: `admins`

**Tests:** `spec/models/user_spec.rb`
- Tested associations and admin scope
- All existing email normalization tests maintained

### 2. Trial Model

**Migration:** `db/migrate/20251025225458_create_trials.rb`
- UUID primary key with proper foreign key to users
- Core fields: industry, business_name, scenario, phone_e164 (all required)
- Vapi integration: vapi_assistant_id, assistant_config (jsonb)
- Trial limits: calls_used (default 0), calls_limit (default 3)
- Status tracking: status (default 'pending'), expires_at (required)
- Comprehensive indexing: status, expires_at, vapi_assistant_id, [user_id, created_at]
- Check constraint: `calls_used <= calls_limit`

**Model:** `app/models/trial.rb`
- Associations: `belongs_to :user`, `has_many :calls, as: :callable`
- Enums: status (pending/active/converted/expired), industry (hvac/gym/dental)
- Validations: presence validations, numericality, custom calls_used_within_limit
- Scopes: `active`, `expired_pending`
- Callbacks: `set_expires_at` (48 hours from creation)
- Methods: `calls_remaining`, `expired?`

**Factory:** `spec/factories/trials.rb`
- Base factory with valid attributes
- Traits: `:active`, `:expired`, `:with_calls`

**Tests:** `spec/models/trial_spec.rb`
- Comprehensive test coverage for all features

### 3. Call Model (Polymorphic)

**Migration:** `db/migrate/20251025225521_create_calls.rb`
- UUID primary key with polymorphic reference to callable (Trial or Business)
- Call metadata: direction, to_e164, from_e164, status (all required)
- External IDs: vapi_call_id, twilio_call_sid (with unique partial indexes)
- Call data: duration_seconds, transcript, recording_url, extracted_lead (jsonb)
- Cost tracking: vapi_cost, twilio_cost, openai_cost (decimal 8,4)
- Timestamps: started_at, ended_at
- Performance indexes: direction, status, [callable_type, callable_id, created_at], created_at

**Model:** `app/models/call.rb`
- Associations: `belongs_to :callable, polymorphic: true`
- Enums: direction (inbound/outbound_trial/outbound_lead), status (initiated/ringing/in_progress/completed/failed)
- Validations: presence of to_e164, uniqueness of external IDs
- Scopes: `completed`, `today`, `for_business`
- Methods: `total_cost`, `duration_minutes`

**Factory:** `spec/factories/calls.rb`
- Base factory with trial as callable
- Traits: `:completed`, `:with_transcript`, `:for_business`

**Tests:** `spec/models/call_spec.rb`
- Tested polymorphic associations with both Trial and Business
- Comprehensive validation and method testing

### 4. Business Model

**Migration:** `db/migrate/20251025225546_create_businesses.rb`
- UUID primary key
- Core fields: name, stripe_customer_id (unique), stripe_subscription_id, status, plan
- Plan limits: calls_included, calls_used_this_period (default 0)
- Vapi integration: vapi_assistant_id
- Indexes: stripe_customer_id (unique), stripe_subscription_id, status, plan

**Model:** `app/models/business.rb`
- Associations: `has_many :business_ownerships`, `has_many :owners`, `has_many :calls as: :callable`
- Enums: status (active/past_due/canceled), plan (starter/pro)
- Validations: presence validations, uniqueness of stripe_customer_id, numericality
- Callbacks: `set_calls_included` (starter=100, pro=500)
- Methods: `calls_remaining`, `over_limit?`

**Factory:** `spec/factories/businesses.rb`
- Base factory with valid attributes
- Traits: `:pro_plan`, `:with_owner`

**Tests:** `spec/models/business_spec.rb`
- Comprehensive test coverage including callback testing

### 5. BusinessOwnership Join Model

**Migration:** `db/migrate/20251025225622_create_business_ownerships.rb`
- UUID primary key
- Foreign keys: user_id (UUID), business_id (UUID)
- Unique index on [user_id, business_id] for many-to-many relationship

**Model:** `app/models/business_ownership.rb`
- Associations: `belongs_to :user`, `belongs_to :business`
- Validations: uniqueness of user_id scoped to business_id

**Factory:** `spec/factories/business_ownerships.rb`
- Base factory with user and business

**Tests:** `spec/models/business_ownership_spec.rb`
- Tested associations and uniqueness validation

## Database Schema

All tables now use UUID primary keys with proper foreign key relationships:

```sql
-- Key tables created:
- users (updated with admin field)
- trials (with check constraint)
- calls (polymorphic)
- businesses (with Stripe fields)
- business_ownerships (join table)
```

## Test Coverage

**67 examples, 0 failures** ✅

- All model specs passing (associations, validations, scopes, methods)
- FactoryBot factories for all models
- No N+1 queries in tests (Bullet clean)
- Comprehensive edge case testing

## Key Features Implemented

### Trial System
- **Trial Limits**: 3 calls max, 48-hour expiration
- **Industry Support**: HVAC, Gym, Dental
- **Status Tracking**: pending → active → converted/expired
- **Vapi Integration**: Assistant config stored as JSONB

### Business System
- **Plan Tiers**: Starter (100 calls), Pro (500 calls)
- **Stripe Integration**: Customer and subscription tracking
- **Usage Tracking**: calls_used_this_period with limits
- **Multi-owner Support**: Many-to-many relationship via BusinessOwnership

### Call System
- **Polymorphic Design**: Calls can belong to Trial OR Business
- **External Integration**: Vapi and Twilio call tracking
- **Cost Tracking**: Separate cost fields for different services
- **Lead Extraction**: JSONB field for captured lead data

## Technical Decisions

### UUID Primary Keys
- Used throughout for security and distributed system readiness
- Proper foreign key references with `type: :uuid`

### Polymorphic Associations
- Call model uses polymorphic `callable` association
- Allows calls to belong to either Trial or Business seamlessly

### Database Constraints
- Check constraint on `trials.calls_used <= calls_limit`
- Unique constraints on external IDs (vapi_call_id, twilio_call_sid)
- Partial indexes for performance optimization

### Rails 8 Enum Syntax
- Updated to new `enum :field, { ... }` syntax
- Proper string-based enums for database storage

## Files Created/Modified

### Migrations
- `db/migrate/20251025225442_add_fields_to_users.rb`
- `db/migrate/20251025225458_create_trials.rb`
- `db/migrate/20251025225521_create_calls.rb`
- `db/migrate/20251025225546_create_businesses.rb`
- `db/migrate/20251025225622_create_business_ownerships.rb`

### Models
- `app/models/user.rb` (updated)
- `app/models/trial.rb` (new)
- `app/models/call.rb` (new)
- `app/models/business.rb` (new)
- `app/models/business_ownership.rb` (new)

### Factories
- `spec/factories/trials.rb` (new)
- `spec/factories/calls.rb` (new)
- `spec/factories/businesses.rb` (new)
- `spec/factories/business_ownerships.rb` (new)

### Tests
- `spec/models/user_spec.rb` (updated)
- `spec/models/trial_spec.rb` (new)
- `spec/models/call_spec.rb` (new)
- `spec/models/business_spec.rb` (new)
- `spec/models/business_ownership_spec.rb` (new)

## Ready for Phase 1

The foundation is now solid for starting Phase 1 (Trial Experience). All core domain models are in place with:

- ✅ Proper associations and validations
- ✅ Comprehensive test coverage
- ✅ Performance-optimized database schema
- ✅ Production-ready constraints and indexes

**Next Phase 1 tickets can now proceed:**
- R1-E02-T001: Landing page with trial signup form
- R1-E02-T002: Magic-link email delivery + UTM capture
- R1-E02-T003: Trial builder UI

## Done Checklist

- [x] All migrations run without errors
- [x] UUID primary keys on all new tables
- [x] Foreign keys with proper indexes
- [x] Unique constraints on vapi_call_id, twilio_call_sid, stripe_customer_id
- [x] Check constraint on trials.calls_used
- [x] Polymorphic associations work (Call belongs to Trial or Business)
- [x] All model specs passing (associations, validations, scopes, methods)
- [x] FactoryBot factories for all models
- [x] No N+1 queries in tests (Bullet clean)
- [x] Schema.rb updated with all changes

## Impact

This ticket establishes the complete data foundation for Beaker AI, enabling:

1. **Trial Experience**: Users can create trials with proper limits and tracking
2. **Business Conversion**: Seamless upgrade from trial to paid business
3. **Call Management**: Unified call tracking across trial and business contexts
4. **Multi-tenancy**: Support for multiple business owners per business
5. **External Integrations**: Ready for Vapi, Twilio, and Stripe webhooks

The polymorphic Call model is particularly important as it allows the same call tracking system to work for both trial calls (limited) and business calls (unlimited), providing a seamless user experience.

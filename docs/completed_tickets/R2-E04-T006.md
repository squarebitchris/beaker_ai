# R2-E04-T006: Business Model + Migration Verification - COMPLETED ✅

**Status:** ✅ COMPLETED  
**Points:** 3  
**Date:** January 27, 2025

## Summary

Verified that the Business model has all required Phase 3 fields with proper StripePlan integration. Fixed inconsistencies in the factory and test files where Pro plan had outdated pricing (500 calls instead of 300). Added comprehensive StripePlan integration tests to ensure the model works correctly with the database-driven pricing system.

## What Was Fixed

### 1. Factory Update ✅

**File:** `spec/factories/businesses.rb`

Updated the `:pro_plan` trait to reflect current pricing (300 calls instead of 500):

```ruby
trait :pro_plan do
  plan { 'pro' }
  calls_included { 300 }  # Updated from 500 to protect margins
end
```

**Why:** The factory was setting 500 calls for Pro plan, which conflicts with the model defaults (300 calls) and seeds configuration (300 calls). This inconsistency would cause test failures and incorrect assumptions about plan limits.

### 2. Factory Spec Update ✅

**File:** `spec/factories_spec.rb`

Updated the test assertion to expect 300 calls for Pro plan:

```ruby
it 'creates pro plan business' do
  business = build(:business, :pro_plan)
  expect(business.plan).to eq('pro')
  expect(business.calls_included).to eq(300)  # Updated from 500
end
```

**Why:** The factory spec was testing for outdated pricing (500 calls), causing test failures with the corrected factory.

### 3. Model Spec Fix ✅

**File:** `spec/models/business_spec.rb`

Fixed incomplete test assertion for `#over_limit?` method:

```ruby
it 'returns true when at limit' do
  business = build(:business, calls_included: 100, calls_used_this_period: 100)
  expect(business).to be_over_limit
end
```

**Why:** The test was missing the business instantiation before the assertion, which would have caused an error.

### 4. Enhanced Test Coverage ✅

**File:** `spec/models/business_spec.rb`

Added comprehensive StripePlan integration tests to verify:

- `#stripe_price_id` returns correct price IDs from StripePlan database records
- StripePlan integration uses database values when available
- Fallback to model defaults when StripePlan records don't exist
- Pro plan correctly defaults to 300 calls across all scenarios

**New test coverage:**
- Tests for `#stripe_price_id` method (3 examples)
- Tests for StripePlan integration with database records (2 examples)
- Tests for fallback behavior without StripePlan records (2 examples)

## Current State Verification

### Database Schema ✅

All Phase 3 fields present in `businesses` table:
- UUID primary key
- `name` (string, required)
- `stripe_customer_id` (string, unique, required)
- `stripe_subscription_id` (string, indexed)
- `plan` (enum: starter/pro, required)
- `status` (enum: active/past_due/canceled, default active)
- `calls_included` (integer, required)
- `calls_used_this_period` (integer, default 0)
- `vapi_assistant_id` (string, indexed)
- `trial_id` (uuid, optional foreign key)

**Indexes:**
- Unique index on `stripe_customer_id` (prevents duplicate conversions)
- Indexes on `plan`, `status`, `stripe_subscription_id`, `trial_id`, `vapi_assistant_id`

### Model Implementation ✅

**app/models/business.rb** has all required features:
- ✅ Associations: `business_ownerships`, `owners`, `calls` (polymorphic), `trial`
- ✅ Enums: status (3 values), plan (2 values)
- ✅ Validations: presence checks, uniqueness, numericality
- ✅ Callbacks: `set_calls_included` integrates with StripePlan
- ✅ Methods: `calls_remaining`, `over_limit?`, `stripe_price_id`
- ✅ StripePlan integration: queries database first, falls back to defaults

### Pricing Configuration ✅

**Pro plan standardized to 300 calls:**
- Model default (`app/models/business.rb` line 38): ✅ 300
- Seeds default (`db/seeds.rb` line 154): ✅ 300
- Factory default (`spec/factories/businesses.rb` line 12): ✅ 300
- Factory spec (`spec/factories_spec.rb` line 73): ✅ 300
- Model spec (`spec/models/business_spec.rb` line 48): ✅ 300

All pricing references are now consistent and aligned with margin protection requirements.

## Test Results

All tests passing:

```bash
$ bundle exec rspec spec/models/business_spec.rb
23 examples, 0 failures

$ bundle exec rspec spec/factories_spec.rb
17 examples, 0 failures
```

**New test coverage:**
- 7 additional examples testing StripePlan integration
- All integration scenarios verified (with database, fallback behavior)
- Edge cases covered (missing StripePlan records)

## Exit Criteria Met

- ✅ Business model has all Phase 3 fields
- ✅ Database schema matches requirements
- ✅ Unique constraints prevent duplicate conversions
- ✅ StripePlan integration working correctly
- ✅ Pro plan standardized to 300 calls across entire codebase
- ✅ Factory aligned with current pricing
- ✅ All model tests passing (23 examples)
- ✅ All factory tests passing (17 examples)

## Files Modified

1. ✅ `spec/factories/businesses.rb` - Updated `:pro_plan` trait (500 → 300 calls)
2. ✅ `spec/factories_spec.rb` - Updated test assertion (500 → 300 calls)
3. ✅ `spec/models/business_spec.rb` - Fixed incomplete test, added StripePlan integration tests

## Technical Notes

### StripePlan Integration Architecture

The Business model uses a two-tier approach for call limits:

1. **Database-driven (preferred):** Queries `StripePlan.for_plan(plan)` to get `calls_included` from the `stripe_plans` table
2. **Model fallback:** Uses `default_calls_for_plan` method when StripePlan record not found

This architecture provides:
- Flexibility to change pricing without code deploys
- Ability to run seeds before Stripe products are created
- Graceful degradation if database records are missing

### Why 300 Calls for Pro Plan?

Updated from 500 to 300 calls to protect sustainable margins per Phase 3 analysis:
- Unit cost per call: ~$0.50
- 500 calls = $250 cost, $499 revenue = 50% margin
- 300 calls = $150 cost, $499 revenue = 70% margin
- 70% margin is sustainable for long-term growth

## Ready for Phase 3

The Business model infrastructure is complete and verified for Phase 3 implementation. The model is ready to be used by:
- `ConvertTrialToBusinessJob` (R2-E04-T005)
- Stripe webhook processing (R2-E04-T004)
- Checkout flow (R2-E04-T003)

No migrations needed - the schema was already correct from Phase 0 (R1-E01-T004).

## Next Steps

This completes the Business model verification ticket. The remaining Phase 3 tickets can now proceed:
- R2-E04-T005: ConvertTrialToBusinessJob (5 pts)
- R2-E04-T007: Clone assistant logic (4 pts)
- R2-E04-T008: Onboarding page (2 pts)
- R2-E04-T009: Agent Ready email (2 pts) - Already done in T005
- R2-E04-T010: Idempotency testing (3 pts) - Already done in T005
- R2-E04-T011: Upgrade button (2 pts)
- R2-E04-T012: Stripe Tax config (2 pts)

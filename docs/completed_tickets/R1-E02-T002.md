# R1-E02-T002: Seed HVAC Scenario Template (Lead Intake Only)

**Epic:** E-002: Trial Flow  
**Points:** 2  
**Priority:** P0  
**Status:** ✅ Completed  
**Date Completed:** October 26, 2025

## Overview

This ticket implemented the foundational HVAC scenario template for lead intake, providing a structured prompt pack that the PromptBuilder service will use to generate personalized AI assistant configurations for trial users.

## What Was Implemented

### 1. Database Migration
- **File:** `db/migrate/20251026030338_create_scenario_templates.rb`
- Created `scenario_templates` table with UUID primary key
- Fields: `key`, `version`, `active`, `prompt_pack` (jsonb), `notes`
- Unique constraint on `(key, active)` where `active = true`
- Proper indexes for performance

### 2. Model Implementation
- **File:** `app/models/scenario_template.rb`
- Validations for required fields and data integrity
- Helper methods: `system_prompt`, `first_message`, `tools`
- Association with trials (optional, nullify on delete)
- Active scope for filtering

### 3. Seed Data
- **File:** `db/seeds.rb`
- HVAC lead intake template with key `"hvac_lead_intake"`
- Version 1, active status
- Complete prompt pack structure:
  - **System prompt:** Professional HVAC assistant specializing in lead intake
  - **First message:** Template with `[COMPANY_NAME]` placeholder
  - **Tools:** `capture_lead` function with comprehensive field schema

### 4. Comprehensive Test Suite
- **File:** `spec/seeds_spec.rb`
- Tests for idempotency (running seeds twice)
- Structure validation for prompt_pack JSON
- Uniqueness constraint verification
- Helper method functionality

## Technical Details

### Prompt Pack Structure
```json
{
  "system": "You are a professional HVAC assistant specializing in lead intake and qualification. Your goal is to gather contact information and understand the customer's HVAC needs. Be friendly, professional, and efficient. Keep calls under 2 minutes.",
  "first_message": "Hi! I'm calling from [COMPANY_NAME] about your HVAC needs. Do you have a few minutes to talk?",
  "tools": [
    {
      "type": "function",
      "function": {
        "name": "capture_lead",
        "description": "Capture lead information when customer provides it",
        "parameters": {
          "type": "object",
          "properties": {
            "name": { "type": "string", "description": "Customer's full name" },
            "phone": { "type": "string", "description": "Customer's phone number" },
            "email": { "type": "string", "description": "Customer's email address" },
            "address": { "type": "string", "description": "Customer's address" },
            "issue_description": { "type": "string", "description": "Description of HVAC issue or need" },
            "urgency": { "type": "string", "enum": ["urgent", "moderate", "low"], "description": "How urgent is the HVAC need" },
            "preferred_contact_time": { "type": "string", "description": "When customer prefers to be contacted" }
          },
          "required": ["name", "phone", "issue_description"]
        }
      }
    }
  ]
}
```

### Database Schema
```sql
CREATE TABLE scenario_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  key VARCHAR NOT NULL,
  version INTEGER NOT NULL,
  active BOOLEAN DEFAULT true NOT NULL,
  prompt_pack JSONB DEFAULT '{}' NOT NULL,
  notes TEXT,
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL
);

-- Unique constraint ensures only one active template per key
CREATE UNIQUE INDEX idx_unique_active_scenario_template 
ON scenario_templates (key, active) 
WHERE active = true;
```

## Verification Results

### ✅ Test Suite
- **3 examples, 0 failures** - All tests pass
- Idempotency verified (running seeds twice creates only 1 record)
- Structure validation confirms proper JSON schema
- Uniqueness constraint prevents duplicate active templates

### ✅ Database Verification
- Template successfully created with UUID: `b40cea25-913c-456b-816b-ee46fdf2aa92`
- All fields populated correctly
- Helper methods return expected values

### ✅ Code Quality
- **RuboCop:** 107 files inspected, no offenses detected
- **RSpec:** 254 examples, 1 failure (unrelated Sentry connectivity issue)
- **Coverage:** 95.37% line coverage

## Key Features

1. **Idempotent Seeding:** Safe to run multiple times without creating duplicates
2. **Structured Prompts:** Professional HVAC-focused conversation flow
3. **Comprehensive Lead Capture:** Required and optional fields for complete lead data
4. **Template System:** Ready for PromptBuilder service integration
5. **Database Integrity:** Proper constraints and indexes for performance

## Integration Points

This template will be used by:
- **R1-E02-T003:** PromptBuilder service (merges persona data)
- **R1-E02-T004:** Vapi client (creates AI assistants)
- **R1-E02-T006:** CreateTrialAssistantJob (background processing)

## Files Modified/Created

- ✅ `db/migrate/20251026030338_create_scenario_templates.rb` (migration)
- ✅ `app/models/scenario_template.rb` (model)
- ✅ `db/seeds.rb` (seed data)
- ✅ `spec/seeds_spec.rb` (tests)
- ✅ `db/schema.rb` (updated automatically)

## Next Steps

With this foundation in place, the next ticket **R1-E02-T003: PromptBuilder service** can now:
1. Load the HVAC scenario template
2. Merge user persona data (company name, industry specifics)
3. Generate final prompt bundles for Vapi assistant creation

## Acceptance Criteria Met

✅ **GIVEN** a clean database  
✅ **WHEN** I run `rails db:seed`  
✅ **THEN** one active "hvac_lead_intake" ScenarioTemplate (version 1) exists with prompt_pack JSON present

All acceptance criteria have been successfully met and verified through comprehensive testing.

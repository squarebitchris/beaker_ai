# R1-E02-T003: PromptBuilder Service Implementation

**Epic:** E-002: Trial Flow  
**Points:** 2  
**Priority:** P0  
**Status:** ✅ Completed  
**Date Completed:** January 26, 2025

## Overview

Implemented the PromptBuilder service that merges ScenarioTemplate prompt_pack with Trial persona data, replacing placeholders like `{{business_name}}` and outputting a hash ready for VapiClient assistant creation.

## What Was Implemented

### 1. PromptBuilder Service (`app/services/prompt_builder.rb`)

**Core Functionality:**
- **Merge Logic**: Implements precedence order: template < kb < persona
- **Placeholder Replacement**: Uses `{{business_name}}` format for maximum flexibility
- **Immutable Operations**: Deep-duplicates all inputs to prevent mutation
- **Graceful Error Handling**: Logs warnings for missing placeholders but doesn't fail
- **VapiClient Ready**: Returns hash with symbol keys compatible with VapiClient.create_assistant

**Key Methods:**
```ruby
PromptBuilder.call(template:, persona:, kb: {})
# Returns: { system:, first_message:, tools: }
```

**Error Handling:**
- Missing placeholders: Logs warning, leaves placeholder unreplaced (graceful degradation)
- Nil text fields: Returns nil without errors
- Empty inputs: Returns safe defaults (empty array for tools)

### 2. Comprehensive Test Suite (`spec/services/prompt_builder_spec.rb`)

**16 Test Cases Covering:**
- ✅ Placeholder replacement in system prompt and first_message
- ✅ Merge precedence (template < kb < persona)
- ✅ Missing placeholder handling with logging
- ✅ Immutability verification (inputs not mutated)
- ✅ Edge cases: nil values, empty inputs, multiple placeholder occurrences
- ✅ Integration test with real ScenarioTemplate factory
- ✅ Tools array preservation

**Test Results:** All 16 tests passing ✅

### 3. Updated Seed Template (`db/seeds.rb`)

**Change Made:**
```ruby
# Before
"first_message" => "Hi! I'm calling from [COMPANY_NAME] about your HVAC needs..."

# After  
"first_message" => "Hi! I'm calling from {{business_name}} about your HVAC needs..."
```

### 4. Updated Factory (`spec/factories/scenario_templates.rb`)

**Change Made:**
```ruby
# Before
"first_message" => "Hi! I'm calling from [COMPANY_NAME] about your HVAC needs..."

# After
"first_message" => "Hi! I'm calling from {{business_name}} about your HVAC needs..."
```

### 5. Updated Seeds Spec (`spec/seeds_spec.rb`)

**Change Made:**
```ruby
# Before
expect(prompt_pack['first_message']).to include('[COMPANY_NAME]')

# After
expect(prompt_pack['first_message']).to include('{{business_name}}')
```

## Technical Implementation Details

### Placeholder Format
- **Format**: `{{business_name}}`, `{{industry}}`, etc.
- **Replacement**: Direct string substitution with persona values
- **Missing Values**: Logged as warnings, placeholders left unreplaced

### Merge Precedence
1. **Template** (base prompt_pack from ScenarioTemplate)
2. **KB** (future knowledge base integration)
3. **Persona** (Trial-specific data - highest priority)

### Deep Merge Logic
```ruby
def deep_merge(base, override)
  result = base.dup
  override.each do |key, value|
    result[key.to_s] = if result[key.to_s].is_a?(Hash) && value.is_a?(Hash)
      deep_merge(result[key.to_s], value)
    else
      deep_dup(value)
    end
  end
  result
end
```

### Placeholder Replacement
```ruby
def replace_placeholders(text)
  return text unless text.is_a?(String)
  
  text.gsub(/\{\{(\w+)\}\}/) do |match|
    key = $1
    value = @persona[key]
    
    if value.nil?
      @missing_placeholders << key
      match # Leave placeholder unreplaced
    else
      value.to_s
    end
  end
end
```

## Quality Assurance

### Testing Results
- **Total Tests**: 270 examples, 0 failures ✅
- **Line Coverage**: 95.51% (574 / 601) ✅
- **Linting**: All RuboCop offenses corrected ✅
- **PromptBuilder Tests**: 16 examples, 0 failures ✅

### Code Quality
- **Immutability**: All inputs deep-duplicated to prevent mutation
- **Error Handling**: Graceful degradation with proper logging
- **Performance**: Efficient string replacement and hash merging
- **Maintainability**: Clean, well-tested service with clear interface

## Integration Points

### Ready for Next Steps
This service provides the foundation for:

1. **R1-E02-T006: CreateTrialAssistantJob**
   ```ruby
   # Will call PromptBuilder like this:
   prompt_bundle = PromptBuilder.call(
     template: trial.scenario_template.prompt_pack,
     persona: {
       "business_name" => trial.business_name,
       "industry" => trial.industry
     }
   )
   ```

2. **Future KB Integration**
   ```ruby
   # Ready for knowledge base integration:
   PromptBuilder.call(
     template: template,
     persona: persona,
     kb: knowledge_base_data
   )
   ```

3. **Trial Builder UI Preview**
   - Can preview generated prompts before creating assistant
   - Real-time placeholder replacement feedback

## Files Modified

### New Files
- `app/services/prompt_builder.rb` - Main service implementation
- `spec/services/prompt_builder_spec.rb` - Comprehensive test suite

### Modified Files
- `db/seeds.rb` - Updated placeholder format
- `spec/factories/scenario_templates.rb` - Updated placeholder format  
- `spec/seeds_spec.rb` - Updated test expectations

## Definition of Done ✅

- [x] PromptBuilder service created with full implementation
- [x] Comprehensive test suite (16 test cases)
- [x] All edge cases covered
- [x] Immutability verified
- [x] Logging for missing placeholders
- [x] Seeds and factories updated to {{placeholder}} format
- [x] All tests passing (270 examples, 0 failures)
- [x] Linting clean (all RuboCop offenses corrected)
- [x] Integration test with real ScenarioTemplate
- [x] Documentation complete

## Next Steps

The PromptBuilder service is now ready to be used by:
1. **CreateTrialAssistantJob** (R1-E02-T006) - Next ticket in sequence
2. **Trial Builder UI** - For prompt preview functionality
3. **Future KB Integration** - When knowledge base features are added

This implementation provides a solid, tested foundation for the trial assistant creation workflow with proper error handling and logging for production resilience.

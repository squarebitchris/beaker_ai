# R2-E04-T012: Stripe Tax Configuration

**Status:** ✅ Completed  
**Points:** 2  
**Completed:** January 26, 2025  
**Epic:** E-004: Monetization

---

## Summary

Enabled Stripe automatic tax calculation for all checkout sessions to ensure compliance with US state sales tax requirements. This provides transparent tax collection based on customer location and eliminates manual tax calculation complexity.

---

## What Was Done

### 1. Updated StripeClient Service

**File:** `app/services/stripe_client.rb`

**Key Changes:**
- Added `automatic_tax: { enabled: true }` parameter to checkout session creation
- Tax calculation now enabled for all subscription checkouts
- No environment variable toggle needed (always enabled for compliance)

**Code Change:**
```ruby
def create_checkout_session(price_id:, customer_email:, metadata: {}, idempotency_key: nil)
  with_circuit_breaker(name: "stripe:create_checkout_session") do
    params = {
      mode: "subscription",
      line_items: [ {
        price: price_id,
        quantity: 1
      } ],
      customer_email: customer_email,
      success_url: ENV.fetch("STRIPE_SUCCESS_URL"),
      cancel_url: ENV.fetch("STRIPE_CANCEL_URL"),
      metadata: metadata,
      automatic_tax: { enabled: true }  # NEW: Enable automatic tax calculation
    }
    
    options = {}
    options[:idempotency_key] = idempotency_key if idempotency_key
    
    Stripe::Checkout::Session.create(params, options)
  end
rescue Stripe::StripeError => e
  raise ApiError, "Stripe API error: #{e.message}"
end
```

**Benefits:**
- Automatic sales tax calculation based on customer location
- Reduces compliance burden for US state tax requirements
- Transparent tax breakdown shown to customers in checkout
- No manual tax rate management required
- Eliminates risk of tax calculation errors

### 2. Added Comprehensive Test Coverage

**File:** `spec/services/stripe_client_spec.rb`

**Unit Test:**
- Verifies `automatic_tax` parameter is included in Stripe API call
- Tests parameter propagation through service layer

```ruby
it 'includes automatic_tax parameter' do
  checkout_session = double('Stripe::Checkout::Session',
    id: 'cs_test_1234567890',
    url: 'https://checkout.stripe.com/pay/cs_test_1234567890'
  )

  expect(Stripe::Checkout::Session).to receive(:create).with(
    hash_including(automatic_tax: { enabled: true }),
    anything
  ).and_return(checkout_session)

  result = client.create_checkout_session(
    price_id: price_id,
    customer_email: customer_email,
    metadata: metadata
  )

  expect(result.id).to eq('cs_test_1234567890')
end
```

**File:** `spec/requests/upgrades_spec.rb`

**Integration Test:**
- Verifies automatic tax parameter in full checkout flow
- Tests end-to-end checkout session creation with tax

```ruby
it "creates checkout session with automatic tax enabled" do
  expect(Stripe::Checkout::Session).to receive(:create) do |params, _options|
    expect(params).to include(automatic_tax: { enabled: true })
    double('Stripe::Checkout::Session', id: 'cs_test_123', url: 'https://checkout.stripe.com/test/123')
  end

  post upgrades_path(trial_id: trial.id), params: { plan: "starter" }

  expect(response).to have_http_status(:redirect)
end
```

---

## Technical Details

### How Stripe Automatic Tax Works

1. **Customer Location Detection:**
   - Stripe automatically determines customer location during checkout
   - Uses billing address or IP address as fallback
   - Supports automatic location collection

2. **Tax Calculation:**
   - Calculates sales tax based on merchant nexus
   - Applies correct tax rates for customer's state
   - Handles local tax jurisdictions
   - Automatically updates when tax laws change

3. **Checkout Experience:**
   - Tax amount shown on checkout page
   - Breakout of base price + tax amount
   - Transparent pricing for customers
   - Location-dependent tax display

### Test Mode vs Production

**Test Mode:**
- Uses Stripe's test tax rates
- Simulates tax calculation without real tax registration
- Good for development and testing
- No actual tax calculation

**Production:**
- Requires Stripe Tax to be enabled in Dashboard
- Must register for tax collection in states where you have nexus
- Real tax rates applied to real payments
- Automatic compliance with tax law changes

---

## Stripe Dashboard Setup Required (Manual)

Users must enable Stripe Tax in their Stripe Dashboard:

### Steps to Enable Stripe Tax:

1. **Navigate to Tax Settings:**
   - Go to Stripe Dashboard → Settings → Tax
   - Click "Enable" on Stripe Tax

2. **Configure Tax Collection:**
   - Select "Automatically calculate tax"
   - Choose US states where you have tax nexus
   - Set customer location collection to "Automatic"

3. **Test Mode Configuration:**
   - In test mode, use Stripe's test tax calculations
   - No tax registration required for testing

### Important Notes:

- Tax calculation requires Stripe Tax to be enabled in Dashboard
- Test mode uses simulated tax rates
- Production requires actual tax registration
- Tax nexus determination is legal requirement
- Consult tax professional for multi-state nexus

---

## Acceptance Criteria Status

✅ **Automatic Tax Parameter:** Added to checkout session creation  
✅ **Service Test:** Unit test verifies parameter presence  
✅ **Integration Test:** Full flow test confirms tax enabled  
✅ **All Tests Passing:** Existing test suite remains green  
✅ **Documentation:** Completion doc created with setup instructions  
✅ **No Environment Toggle:** Always enabled for compliance  

---

## Testing Results

```bash
bundle exec rspec spec/services/stripe_client_spec.rb
# 17 examples, 0 failures (added 1 test)

bundle exec rspec spec/requests/upgrades_spec.rb
# All examples passing (added integration test)
```

**Test Coverage:**
- StripeClient now has 17 specs (was 16)
- Upgrades spec now includes tax verification
- All existing tests still passing
- No breaking changes introduced

---

## Manual Testing Checklist

To verify Stripe Tax is working:

1. **Create a trial** and navigate to upgrade page
2. **Click "Choose Starter" or "Choose Pro"**
3. **Verify checkout URL** contains automatic tax parameter:
   ```bash
   # Check logs for: automatic_tax: { enabled: true }
   tail -f log/development.log | grep automatic_tax
   ```
4. **Complete test checkout** with test card `4242 4242 4242 4242`
5. **Verify in Stripe Dashboard:**
   - Checkout session shows tax calculation
   - Tax amount displayed in test mode
   - Automatic tax parameter present

---

## Files Modified

- `app/services/stripe_client.rb` - Added automatic_tax parameter
- `spec/services/stripe_client_spec.rb` - Added unit test for automatic_tax
- `spec/requests/upgrades_spec.rb` - Added integration test for tax in checkout flow

---

## What Was NOT Changed

**No Environment Variables Added:**
- Tax is always enabled (no toggle needed)
- Simplifies implementation and ensures compliance
- Always-on approach reduces configuration complexity

**No Dashboard Configuration Code:**
- Stripe Tax must be enabled manually in Dashboard
- This is a one-time setup per Stripe account
- Documented for users in completion doc

**Existing Parameters Unchanged:**
- All other checkout session parameters remain the same
- No impact on existing checkout flow
- Backwards compatible with existing sessions

---

## Dependencies

### Required for Full Functionality:

1. **Stripe Tax Enabled in Dashboard:**
   - Navigate to Stripe Dashboard → Settings → Tax
   - Click "Enable Stripe Tax"
   - Configure tax nexus states

2. **Test Mode:**
   - Uses test tax rates automatically
   - No additional setup required
   - Good for development/testing

3. **Production:**
   - Must register for tax collection
   - Determine nexus states (legal requirement)
   - Enable in Stripe Dashboard before going live

---

## Risk Assessment

### No Risks Introduced

**Why:**
- Automatic tax adds functionality without breaking existing flows
- Test mode provides safe testing environment
- All existing tests passing
- Backwards compatible with existing checkout sessions

### Residual Considerations

- **Tax Nexus Determination:** Legal requirement to determine where you have nexus
- **Production Tax Registration:** Must register before collecting real taxes
- **Tax Rate Changes:** Stripe handles automatically, but test rates stay constant

---

## Next Steps

This completes Phase 3 (Stripe & Business Conversion) ticket list. All 12 tickets now complete:

- ✅ R2-E04-T001: Stripe Client Setup
- ✅ R2-E04-T002: Create Stripe Products/Prices
- ✅ R2-E04-T003: Checkout Session Endpoint
- ✅ R2-E04-T004: Stripe Webhook Handler
- ✅ R2-E04-T005: ConvertTrialToBusinessJob
- ✅ R2-E04-T006: Business Model Verification
- ✅ R2-E04-T007: Assistant Cloning Logic
- ✅ R2-E04-T008: Onboarding Page
- ✅ R2-E04-T009: Agent Ready Email
- ✅ R2-E04-T010: Idempotency Testing
- ✅ R2-E04-T011: Upgrade CTA in Trial UI
- ✅ R2-E04-T012: Stripe Tax Configuration

Ready for Phase 4: Paid Product + Dashboard.

---

## References

- [Stripe Automatic Tax Documentation](https://stripe.com/docs/tax)
- [Stripe Checkout Session API](https://stripe.com/docs/api/checkout/sessions/create#create_checkout_session-automatic_tax-enabled)
- [Test Mode Tax Calculation](https://stripe.com/docs/testing#tax)
- Phase 3 Setup Analysis: `docs/PHASE-3-SETUP-ANALYSIS.md`
- Stripe Tax Setup Guide: https://stripe.com/docs/tax/guides/overview

---

## Commit Message

```
feat(phase3): Enable Stripe automatic tax calculation for all checkout sessions

- Add automatic_tax: { enabled: true } to StripeClient#create_checkout_session
- Add unit test to verify automatic_tax parameter in StripeClient spec
- Add integration test to verify tax in full checkout flow in upgrades spec
- Create R2-E04-T012.md completion document with implementation details
- Always-enabled approach ensures tax compliance
- Comprehensive test coverage at service and integration levels

Ref: R2-E04-T012
```


# R1-E03-T004: IntentClassifier Service

**Epic:** E-003: Webhook Processing & Conversion Driver  
**Points:** 3  
**Status:** ✅ Completed  
**Completed:** January 26, 2025

## Context

In Phase 2 of the project, the system needs to classify call intent from Vapi webhook payloads to understand what each call was about (lead generation, scheduling, general info, etc.). This classification helps users understand their call data and enables future analytics and reporting features.

The IntentClassifier service determines call intent using a two-tier approach:
1. **Function calls** (preferred): Checks for specific function names executed during the call
2. **Transcript keywords** (fallback): Searches the conversation transcript for intent-indicating keywords

## What Was Implemented

### Created Service: `app/services/intent_classifier.rb`

A pure service class that classifies call intent from Vapi webhook payloads:

**Key Features:**
- **Class Method Pattern**: Uses `.call(call_payload, default_slug = nil)` for stateless extraction
- **Two-Tier Classification**: 
  - Tier 1: Function call classification (`capture_lead` → `lead_intake`, `offer_times` → `scheduling`)
  - Tier 2: Transcript keyword fallback (searches for "book"/"appointment" or "interested"/"join")
  - Tier 3: Default fallback (returns provided `default_slug` or `"info"`)
- **Flexible Input Handling**: Uses `with_indifferent_access` to handle both string and symbol keys
- **Robust Error Handling**: Handles nil values, empty arrays, and missing keys gracefully
- **Deterministic Output**: Returns string values matching Call model enum (`lead_intake`, `scheduling`, `info`, `other`)

**Implementation Details:**
```ruby
def self.call(call_payload, default_slug = nil)
  call_payload = (call_payload || {}).with_indifferent_access
  
  # Tier 1: Function call classification (preferred)
  funcs = Array(call_payload[:functionCalls])
  return "lead_intake" if funcs.any? { |f| f["name"] == "capture_lead" }
  return "scheduling" if funcs.any? { |f| f["name"] == "offer_times" }
  
  # Tier 2: Transcript keyword fallback
  transcript = Array(call_payload[:transcript])
  msg = transcript.map { |t| t["message"]&.downcase }.compact.join(" ")
  
  return "scheduling" if msg.match?(/\b(book|appointment)\b/)
  return "lead_intake" if msg.match?(/\b(interested|join)\b/)
  
  # Tier 3: Default fallback
  default_slug.presence || "info"
end
```

### Comprehensive Test Coverage

**File:** `spec/services/intent_classifier_spec.rb` (21 examples covering):

- Function call classification (capture_lead, offer_times)
- Transcript keyword fallback (booking, appointment, interested, join)
- Default fallback with and without provided default_slug
- Edge cases (empty payload, nil transcript, missing keys)
- Indifferent access (works with both string and symbol keys)
- Case-insensitive matching
- Multiple function calls (prefers first match)
- Nil message handling

### Integration with CallProcessor

**Updated:** `app/services/webhooks/vapi/call_processor.rb`

Added intent classification to call processing flow:
- Calls `IntentClassifier.call(call_data)` to classify intent
- Sets `intent` attribute on Call records during webhook processing
- Intent is stored in database via Call model enum

**Code Change:**
```ruby
call.assign_attributes(
  # ... existing attributes ...
  intent: IntentClassifier.call(call_data)  # Added this line
)
```

### Enhanced Test Coverage

**Updated:** `spec/services/webhooks/vapi/call_processor_spec.rb`
- Added assertion to verify intent is set correctly: `expect(call.intent).to eq("lead_intake")`
- Added new test context for scheduling function calls
- Verified intent classification for both lead_intake and scheduling scenarios

**Updated:** `spec/jobs/webhook_processor_job_spec.rb`
- Added intent verification to integration test: `expect(call.intent).to eq("info")`
- Verified end-to-end intent classification through webhook processing

## Test Results

**All 54 tests passing:**
- 21 IntentClassifier service specs ✅
- 21 CallProcessor specs ✅  
- 12 WebhookProcessorJob integration specs ✅

**Coverage:** 100% for IntentClassifier service

## Key Design Decisions

1. **Pure Service Pattern**: No database access, making it easily testable and reusable
2. **Class Method**: Stateless design following LeadExtractor precedent
3. **Function Calls > Transcript**: Function calls provide the most reliable intent signal
4. **Regex with Word Boundaries**: Ensures accurate keyword matching (e.g., "book" in "I want to book" but not in "books")
5. **Default to "info"**: Graceful fallback prevents nil intents in database

## Integration with Existing System

The IntentClassifier integrates seamlessly with existing components:

- **LeadExtractor**: Parallel implementation pattern for consistency
- **CallProcessor**: Automatically classifies every incoming call
- **Call Model**: Enum supports `lead_intake`, `scheduling`, `info`, `other`
- **Webhook Flow**: Intent classification happens automatically during webhook processing

## Files Created/Modified

**Created:**
- `app/services/intent_classifier.rb` (24 lines)
- `spec/services/intent_classifier_spec.rb` (249 lines)

**Modified:**
- `app/services/webhooks/vapi/call_processor.rb` (1 line added)
- `spec/services/webhooks/vapi/call_processor_spec.rb` (28 lines added)
- `spec/jobs/webhook_processor_job_spec.rb` (2 lines added)

**Total Lines:** ~304 lines of code and tests

## Next Steps

This ticket enables:
- R1-E03-T006 (CallCard ViewComponent) - Can display intent badges
- R1-E03-T009 (Mini-report UI) - Can show intent classification
- Future analytics features - Intent data available for reporting

## References

- start.md: Section 10 (IntentClassifier implementation)
- BUILD-GUIDE.md: Pattern matching for service implementations
- R1-E03-T003 (LeadExtractor): Similar service pattern


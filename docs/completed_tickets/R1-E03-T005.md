# R1-E03-T005: TrialCall Model + Database Migration

**Epic:** E-003: Mini-Report (Phase 2)  
**Points:** 2  
**Status:** ✅ Completed  
**Date:** October 26, 2025

## Overview

Extended the existing polymorphic `Call` model with Phase 2 fields required for the mini-report UI, rather than creating a separate `trial_calls` table. This approach maintains the clean polymorphic pattern already established while adding the necessary captured lead data and scenario context.

## Context & Why This Matters

Phase 2 requires storing captured lead data (name, phone, email, goal) and scenario context for the mini-report UI after calls complete. While the original spec suggested a separate `trial_calls` table, the current implementation uses a polymorphic `Call` model that works for both trials and businesses. This ticket extends that model with Phase 2 fields while maintaining backward compatibility.

### Key Decision

**Decision:** Extend existing `Call` model instead of creating separate `TrialCall` table

**Rationale:**
- Maintains DRY principle (single source of truth for calls)
- Simpler queries (one table, one model)
- Consistent polymorphic pattern already established
- Avoids unnecessary table proliferation
- Both trial and business calls need similar captured data

## Implementation

### 1. Database Migration

**File:** `db/migrate/20251026064023_add_phase2_fields_to_calls.rb`

Added two new fields to the `calls` table:
- `captured` (jsonb, default: {}, null: false) - Processed/validated lead data for UI display
- `scenario_slug` (string) - Stores which scenario was used (lead_intake, scheduling, info)

Added appropriate indexes:
- B-tree index on `scenario_slug` for filtering
- GIN index on `captured` for fast JSONB queries

```ruby
class AddPhase2FieldsToCalls < ActiveRecord::Migration[8.1]
  def change
    # Phase 2: Store captured lead data separately from extracted_lead
    # extracted_lead = raw extraction from LeadExtractor service
    # captured = processed/validated lead data for UI display
    add_column :calls, :captured, :jsonb, default: {}, null: false
    
    # Store which scenario was used (lead_intake, scheduling, info)
    add_column :calls, :scenario_slug, :string
    
    # Add index for querying by scenario
    add_index :calls, :scenario_slug
    
    # Add GIN index for JSONB queries on captured fields
    add_index :calls, :captured, using: :gin
  end
end
```

### 2. Call Model Enhancements

**File:** `app/models/call.rb`

Added Phase 2 scopes for efficient querying:
- `.with_captured_leads` - Filters calls that have captured lead data
- `.by_scenario(slug)` - Filters calls by scenario type
- `.for_trial(trial_id)` - Gets calls for a specific trial

Added helper methods for accessing captured data:
- `captured_name` - Returns captured name
- `captured_phone` - Returns captured phone number
- `captured_email` - Returns captured email
- `captured_goal` - Returns captured goal/intent
- `has_captured_data?` - Checks if call has captured data

```ruby
# Phase 2 scopes
scope :with_captured_leads, -> { where.not("captured = '{}'::jsonb") }
scope :by_scenario, ->(slug) { where(scenario_slug: slug) }
scope :for_trial, ->(trial_id) { where(callable_type: "Trial", callable_id: trial_id) }

# Helper methods for captured data
def captured_name
  captured.dig("name")
end

def captured_phone
  captured.dig("phone")
end

def captured_email
  captured.dig("email")
end

def captured_goal
  captured.dig("goal") || captured.dig("intent")
end

def has_captured_data?
  captured.present? && captured.any?
end
```

### 3. Trial Model Enhancements

**File:** `app/models/trial.rb`

Added convenience methods for Phase 2 queries:
- `trial_calls` - Returns calls specific to trial (filters by callable_type)
- `latest_call` - Gets the most recent call
- `calls_with_leads` - Returns calls that have captured lead data

```ruby
# Phase 2 convenience methods
def trial_calls
  calls.where(callable_type: "Trial")
end

def latest_call
  calls.order(created_at: :desc).first
end

def calls_with_leads
  calls.with_captured_leads
end
```

### 4. Factory Updates

**File:** `spec/factories/calls.rb`

Added new traits for Phase 2 testing:
- `with_captured_lead` - Creates call with sample captured data (name, phone, email, goal)
- `lead_intake_scenario` - Creates call for lead intake scenario with captured data
- `scheduling_scenario` - Creates call for scheduling scenario with appointment data

```ruby
trait :with_captured_lead do
  captured do
    {
      name: Faker::Name.name,
      phone: "+1#{Faker::Number.number(digits: 10)}",
      email: Faker::Internet.email,
      goal: 'Request quote'
    }
  end
end

trait :lead_intake_scenario do
  scenario_slug { 'lead_intake' }
  intent { 'lead_intake' }
  with_captured_lead
end

trait :scheduling_scenario do
  scenario_slug { 'scheduling' }
  intent { 'scheduling' }
  captured do
    {
      name: Faker::Name.name,
      phone: "+1#{Faker::Number.number(digits: 10)}",
      preferred_date: '2025-11-15',
      preferred_time: '2:00 PM'
    }
  end
end
```

### 5. Comprehensive Specs

**File:** `spec/models/call_spec.rb`

Added test coverage for:
- New scopes (with_captured_leads, by_scenario, for_trial)
- Captured data helper methods (captured_name, captured_phone, etc.)
- has_captured_data? method with edge cases

All specs passing (23 examples for Call model).

## Data Model Rationale

### captured vs extracted_lead

The decision to add a separate `captured` field alongside `extracted_lead` provides clear separation:

- **extracted_lead**: Raw extraction output from LeadExtractor service (may have gaps, require validation)
- **captured**: Processed/validated lead data ready for UI display (always structured, complete)

This allows:
1. Tracking of raw extraction quality vs final output
2. Debugging extraction issues independently
3. Different validation rules for each
4. Future A/B testing of extraction algorithms

### scenario_slug Field

Stores which scenario template was used (lead_intake, scheduling, info). This enables:
- Querying calls by scenario type
- Aggregating conversion rates by scenario
- Linking to ScenarioTemplate for future enhancements
- Filtering in the mini-report UI

## Testing

### Spec Results

All 448 specs passing:
- 23 Call model specs (including 11 new Phase 2 specs)
- 17 factory specs (including new traits)
- All existing specs still passing (no regressions)

### Manual Verification

Tested in Rails console:
```ruby
trial = Trial.create!(...)
call = trial.calls.create!(
  direction: 'outbound_trial',
  to_e164: '+15551234567',
  status: 'completed',
  captured: { name: 'John Doe', phone: '+15551234567' },
  scenario_slug: 'lead_intake'
)

call.has_captured_data? # => true
call.captured_name      # => "John Doe"
call.captured_phone     # => "+15551234567"
```

### CI Status

- ✅ All RSpec tests passing (448 examples, 0 failures)
- ✅ RuboCop passing (auto-corrected trailing whitespace)
- ✅ Factory lint passing (all factories valid)
- ✅ No linter errors

## Files Modified

- ✅ `db/migrate/20251026064023_add_phase2_fields_to_calls.rb` (new)
- ✅ `app/models/call.rb` (updated)
- ✅ `app/models/trial.rb` (updated)
- ✅ `spec/factories/calls.rb` (updated)
- ✅ `spec/models/call_spec.rb` (updated)
- ✅ `db/schema.rb` (auto-generated)

## Acceptance Criteria Met

✅ Database migration adds `captured` and `scenario_slug` fields  
✅ Proper indexes added (scenario_slug, GIN on captured)  
✅ Call model has Phase 2 scopes (with_captured_leads, by_scenario, for_trial)  
✅ Helper methods for accessing captured data work correctly  
✅ Trial model has convenience methods (trial_calls, latest_call, calls_with_leads)  
✅ Factory traits for Phase 2 scenarios added and tested  
✅ Comprehensive specs for new functionality  
✅ All existing tests still passing (no regressions)  
✅ Linting passing (RuboCop auto-corrected)

## Gotchas & Lessons Learned

### Trailing Whitespace

RuboCop flagged trailing whitespace in new code. This was auto-corrected. Best practice: run `bundle exec rubocop -a` before committing.

### JSONB Index Type

Used GIN index on `captured` field for fast JSONB queries. B-tree indexes don't work well with JSONB data, so GIN is required.

### Polymorphic Association

Kept the polymorphic association (`callable`) since it already handles both Trial and Business calls. No need to duplicate this pattern.

## Dependencies

This ticket builds on:
- ✅ R1-E01-T004: Base models (User, Trial, Call, Business)
- ✅ R1-E03-T001: Vapi webhook endpoint
- ✅ R1-E03-T003: LeadExtractor service
- ✅ R1-E03-T004: IntentClassifier service

Enables:
- ✅ R1-E03-T006: CallCard ViewComponent (can now access captured data)
- ✅ R1-E03-T007: AudioPlayer component (can display call details)
- ✅ R1-E03-T009: Mini-report UI (can filter by scenario, display captured fields)

## Next Steps

Phase 2 Mini-Report flow:
1. Webhook receives call.ended event (R1-E03-T002 ✅)
2. ProcessVapiEventJob extracts lead data and stores in `captured` field (R1-E03-T005 ✅)
3. CallCard ViewComponent displays captured data from call (R1-E03-T006)
4. TrialSessionChannel broadcasts updates via Turbo Streams (R1-E03-T008)

## References

- start.md: Section "Phase 2 — Trial Webhooks & Mini-Report"
- BUILD-GUIDE.md: Pattern 1 (Polymorphic associations), Pattern 3 (JSONB storage)
- ticket-breakdown.md: R1-E03-T005 detailed specifications


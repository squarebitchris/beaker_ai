# R1-E02-T014: TrialReaperJob (Cleanup Expired Trials)

**Status:** ✅ Completed  
**Points:** 2  
**Epic:** E-002 Trial Flow  
**Completed:** October 26, 2025

## Summary

Implemented automated trial cleanup job to delete expired trials older than 7 days, preventing database bloat and reducing storage costs. Includes Sentry alerting for anomalous cleanup volumes that might indicate abuse patterns or system issues.

## Implementation Details

### Files Created/Modified

1. **`app/jobs/trial_reaper_job.rb`**
   - **Deletion criteria:** Trials with `expires_at < 7.days.ago` AND `status != 'converted'`
   - **Cascade deletion:** Associated `Call` records deleted via `dependent: :destroy` on Trial model
   - **Logging:** Info-level logs for normal cleanup, warning-level for large batches
   - **Sentry alerting:** Captures warning if >100 trials deleted in single run (potential abuse/system issue)
   - **Queue:** `low` priority (runs during off-hours, doesn't block critical jobs)

2. **`config/recurring.yml`**
   - **Production schedule:** Daily at 3:00 AM
   - **Development schedule:** Every 30 minutes (for testing)
   - Uses SolidQueue recurring jobs (Rails 8.1 built-in)

3. **`app/models/trial.rb`**
   - Confirmed `has_many :calls, dependent: :destroy` for cascade deletion
   - No orphan `Call` records left after trial deletion

4. **Test Files**
   - `spec/jobs/trial_reaper_job_spec.rb` - Comprehensive specs for deletion logic, edge cases, Sentry alerts
   - Tests cover: expired trials, grace period, converted trials, associated calls, large batch alerts

## Job Logic

```ruby
def perform
  cutoff_date = 7.days.ago
  
  # Find expired trials older than 7 days (excluding converted ones)
  expired_trials = Trial.where("expires_at < ?", cutoff_date)
                        .where.not(status: "converted")
  
  count = expired_trials.count
  return if count.zero?
  
  Rails.logger.info("[TrialReaper] Deleting #{count} expired trials older than #{cutoff_date}")
  
  # Delete trials (use destroy_all to trigger dependent: :destroy callbacks for calls)
  expired_trials.destroy_all
  
  # Alert if massive cleanup (potential abuse or system issue)
  if count > 100
    Sentry.capture_message(
      "Large trial cleanup: #{count} trials deleted",
      level: :warning,
      extra: {
        cutoff_date: cutoff_date.iso8601,
        deleted_count: count
      }
    )
  end
  
  Rails.logger.info("[TrialReaper] Cleanup complete. Deleted #{count} trials.")
end
```

## Technical Decisions

### 7-Day Grace Period
**Decision:** Delete trials 7 days after expiration (not immediately)

**Rationale:**
- **Data retention:** Allows post-trial analysis/debugging
- **Customer support:** Can review trial data if user contacts support
- **Conversion window:** Gives users extra time to convert after trial expires
- **Compliance:** Meets GDPR "right to erasure" without being too aggressive

**Alternative considered:** Immediate deletion on expiry (rejected - too aggressive)

### `destroy_all` vs. `delete_all`
**Decision:** Use `destroy_all` to trigger callbacks

**Rationale:**
- **Cascade deletion:** `dependent: :destroy` on Trial model requires callbacks
- **Audit trail:** `after_destroy` callbacks can log deletions (future)
- **Data integrity:** Ensures associated `Call` records are deleted
- **Performance:** Acceptable for daily batch job (not high-frequency)

**Trade-off:** Slower than `delete_all` (runs callbacks), but necessary for data integrity

### Converted Trials Exemption
**Decision:** Never delete trials with `status: "converted"`

**Rationale:**
- **Historical record:** Converted trials are business records
- **Revenue tracking:** Need conversion data for analytics
- **Customer support:** May need to reference original trial
- **Future:** Move to `business.trial` association if storage becomes issue

### Sentry Threshold (>100 trials)
**Decision:** Alert on >100 deletions in single run

**Rationale:**
- **Normal volume:** Expect 5-20 trials/day in MVP, ~140 in 7 days
- **Abuse indicator:** >100 suggests abuse attack or trial surge
- **System health:** Could indicate expiration bug (all trials expiring at once)
- **Actionable:** Ops team can investigate patterns

## Scheduling

### Production: Daily at 3:00 AM
```yaml
trial_reaper:
  class: TrialReaperJob
  queue: low
  schedule: "0 3 * * *"  # Every day at 3:00 AM
```

**Rationale:**
- **Low traffic:** 3:00 AM is off-peak for US users
- **Database load:** Minimal impact during low-activity hours
- **Recovery time:** If job fails, team has working hours to investigate

### Development: Every 30 minutes
```yaml
trial_reaper:
  class: TrialReaperJob
  queue: low
  schedule: "*/30 * * * *"  # Every 30 minutes
```

**Rationale:**
- **Testing:** Frequent runs allow rapid iteration
- **Verification:** Can test deletion logic without waiting 24 hours

## Test Coverage

### Spec Scenarios

1. **Deletes expired trials older than 7 days**
   ```ruby
   trial = create(:trial, expires_at: 10.days.ago)
   expect { TrialReaperJob.perform_now }.to change(Trial, :count).by(-1)
   ```

2. **Does not delete trials within 7-day grace period**
   ```ruby
   trial = create(:trial, expires_at: 5.days.ago)
   expect { TrialReaperJob.perform_now }.not_to change(Trial, :count)
   ```

3. **Does not delete converted trials**
   ```ruby
   trial = create(:trial, status: "converted", expires_at: 10.days.ago)
   expect { TrialReaperJob.perform_now }.not_to change(Trial, :count)
   ```

4. **Deletes associated calls via cascade**
   ```ruby
   trial = create(:trial, :with_calls, expires_at: 10.days.ago)
   expect { TrialReaperJob.perform_now }.to change(Call, :count).by(-2)
   ```

5. **Sends Sentry alert for large cleanup**
   ```ruby
   create_list(:trial, 150, expires_at: 10.days.ago)
   expect(Sentry).to receive(:capture_message).with(/Large trial cleanup/, anything)
   TrialReaperJob.perform_now
   ```

6. **Handles zero expired trials**
   ```ruby
   expect { TrialReaperJob.perform_now }.not_to raise_error
   # Logs "0 trials" and returns early
   ```

### Coverage: 90.63% overall, 100% for TrialReaperJob

## Acceptance Criteria Met

- ✅ Deletes trials with `expires_at < 7.days.ago`
- ✅ Excludes converted trials from deletion
- ✅ Cascade deletes associated `Call` records
- ✅ Scheduled for daily 3:00 AM runs (production)
- ✅ Logs deletion activity for audit trail
- ✅ Sends Sentry alert for >100 deletions
- ✅ Comprehensive test coverage
- ✅ Low priority queue (doesn't block critical jobs)

## Database Impact

### Typical Volume (MVP)
- **Trials created:** 10/day
- **Trials eligible for deletion:** ~70/week (7-day retention)
- **Deletion time:** ~50ms per trial (includes associated calls)
- **Total job time:** ~3-5 seconds for 70 trials

### Storage Savings
- **Trial record:** ~2 KB (JSONB fields)
- **Call records:** ~5 KB each (transcript, metadata)
- **Weekly cleanup:** ~70 trials × 2 KB + ~140 calls × 5 KB = ~840 KB/week
- **Annual savings:** ~44 MB (negligible, but keeps DB tidy)

**Note:** Primary benefit is data hygiene, not storage cost reduction

## Dependencies

- Requires: T010 (TrialsController), T011 (trial UI)
- Enables: Automated trial lifecycle management
- Integrates with: T012 (abuse prevention - prevents bloat from attacks)

## Monitoring & Operations

### Logs
```
[TrialReaper] Deleting 42 expired trials older than 2025-10-19 03:00:00 UTC
[TrialReaper] Cleanup complete. Deleted 42 trials.
```

### Sentry Alerts
```
Large trial cleanup: 150 trials deleted
Level: warning
Extra data:
  cutoff_date: "2025-10-19T03:00:00Z"
  deleted_count: 150
```

### Manual Execution
```bash
# Production
heroku run rails runner "TrialReaperJob.perform_now"

# Local
rails runner "TrialReaperJob.perform_now"
```

## Future Enhancements (Phase 2+)

- **Soft delete:** Add `deleted_at` timestamp instead of hard delete (data recovery)
- **Archive to S3:** Export trial data to S3 before deletion (compliance)
- **Configurable retention:** ENV var for grace period (default 7 days)
- **Metrics:** Track deletion count in analytics dashboard
- **Batch size:** Process in chunks if volume exceeds 1000 trials/run

## Notes

- Job uses `destroy_all` (not `delete_all`) to trigger `dependent: :destroy` callbacks
- Converted trials are never deleted (business records)
- Sentry threshold (>100) may need adjustment based on production volume
- Grace period (7 days) balances data retention with storage costs


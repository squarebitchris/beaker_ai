# R1-E01-T006: Build webhook receiver framework with signature verification

**Status**: ✅ Completed  
**Points**: 5  
**Date:** October 25, 2025 

## Goal

Build a secure webhook receiver framework that can handle incoming webhooks from Stripe, Twilio, and Vapi with proper signature verification, idempotency, and async processing using Sidekiq.

## Implementation Summary

### Core Components Implemented

1. **WebhookEvent Model** (`app/models/webhook_event.rb`)
   - UUID primary key for security
   - Provider enum (stripe, twilio, vapi)
   - Status enum (pending, processing, completed, failed)
   - Event tracking with retry logic
   - Unique constraint on provider + event_id for idempotency

2. **WebhooksController** (`app/controllers/webhooks_controller.rb`)
   - Unified endpoint for all webhook providers
   - Signature verification for each provider:
     - Stripe: Uses `Stripe::Webhook.construct_event`
     - Twilio: Uses `Twilio::Security::RequestValidator`
     - Vapi: Uses HMAC-SHA256 signature verification
   - Request body caching and parsing
   - Idempotency handling with `find_or_create_by!`

3. **WebhookProcessorJob** (`app/jobs/webhook_processor_job.rb`)
   - Async processing using Sidekiq
   - Retry logic with exponential backoff
   - Event routing based on provider and event type
   - Error handling with Sentry integration

4. **Database Migration** (`db/migrate/[timestamp]_create_webhook_events.rb`)
   - UUID primary key
   - Comprehensive indexing strategy
   - Unique constraint for idempotency
   - JSONB payload storage

### Security Features

- **Signature Verification**: Each provider uses their specific signature verification method
- **Idempotency**: Unique constraint prevents duplicate event processing
- **Request Body Caching**: Prevents multiple reads of request body
- **Error Handling**: Comprehensive error handling with Sentry integration

### Testing

- **Model Tests**: Validations, enums, scopes, and helper methods
- **Controller Tests**: Signature verification for all providers
- **Job Tests**: Processing logic and error handling
- **Factory Support**: Complete FactoryBot factories for testing

### Configuration

- **Sentry Integration**: Error monitoring and alerting
- **Environment Variables**: Secure storage of webhook secrets
- **Routes**: Clean webhook endpoints for each provider

## Files Created/Modified

### New Files
- `app/models/webhook_event.rb` - Webhook event model
- `app/controllers/webhooks_controller.rb` - Webhook receiver controller
- `app/jobs/webhook_processor_job.rb` - Async webhook processor
- `db/migrate/[timestamp]_create_webhook_events.rb` - Database migration
- `spec/models/webhook_event_spec.rb` - Model tests
- `spec/controllers/webhooks_controller_spec.rb` - Controller tests
- `spec/jobs/webhook_processor_job_spec.rb` - Job tests
- `spec/factories/webhook_events.rb` - Factory definitions

### Modified Files
- `Gemfile` - Added Stripe, Twilio, and Sentry gems
- `config/routes.rb` - Added webhook routes
- `config/initializers/sentry.rb` - Sentry configuration

## API Endpoints

```
POST /webhooks/stripe   - Stripe webhook endpoint
POST /webhooks/twilio   - Twilio webhook endpoint  
POST /webhooks/vapi     - Vapi webhook endpoint
```

## Environment Variables Required

```bash
# Webhook secrets
STRIPE_WEBHOOK_SECRET=whsec_...
TWILIO_AUTH_TOKEN=...
VAPI_WEBHOOK_SECRET=...

# Sentry
SENTRY_DSN=https://...@sentry.io/...
SENTRY_TRACES_SAMPLE_RATE=0.1
```

## Testing Status

- ✅ All webhook tests passing (21/22 tests pass, 1 pending)
- ✅ Model tests passing
- ✅ Job tests passing
- ✅ Linting issues resolved

## Next Steps

The webhook framework is ready for:
1. **Phase 2**: Implement specific webhook processors for Vapi call events
2. **Phase 3**: Implement Stripe checkout session processors
3. **Phase 4**: Implement Twilio call status processors

## Technical Notes

- Uses Sidekiq for background job processing
- Implements proper signature verification for all three providers
- Handles both JSON and form-encoded webhook payloads
- Includes comprehensive error handling and retry logic
- Follows Rails best practices for security and performance
# R2-E04-T001: Stripe Client Setup + API Keys

**Status:** ✅ Completed  
**Points:** 2  
**Completed:** January 26, 2025  
**Epic:** E-004: Monetization

---

## Summary

Migrated `StripeClient` from raw Net::HTTP to the official Stripe Ruby SDK for better maintainability, feature support, and idempotency handling. Added comprehensive idempotency key support for checkout sessions while preserving circuit breaker patterns.

---

## What Was Done

### 1. Refactored StripeClient Implementation

**File:** `app/services/stripe_client.rb`

**Key Changes:**
- Replaced Net::HTTP with Stripe Ruby SDK (v12.0)
- Removed custom `make_request` helper method
- Added `idempotency_key` parameter to `create_checkout_session`
- All methods now use Stripe SDK: `Stripe::Checkout::Session`, `Stripe::Subscription`, `Stripe::Customer`, etc.
- Maintained circuit breaker integration via `ApiClientBase`
- Improved error handling with Stripe-specific exceptions

**Migration Benefits:**
- Cleaner, more maintainable code
- Automatic retry handling from SDK
- Better error types (`Stripe::StripeError`, `Stripe::InvalidRequestError`)
- Native idempotency support
- Stays current with Stripe API changes

### 2. Enhanced Test Coverage

**File:** `spec/services/stripe_client_spec.rb`

**Updates:**
- Replaced WebMock stubs with RSpec doubles for Stripe SDK objects
- Added test for idempotency key propagation
- Verified circuit breaker behavior with Stripe exceptions
- Tested fallback behavior for read operations
- All 16 specs passing with 0 failures

**Test Coverage:**
- `create_checkout_session` with idempotency
- `get_subscription` with 404 handling
- `get_customer` with nil fallback
- `create_customer` with metadata
- `cancel_subscription` via instance method
- `get_payment_intent` with error handling
- Circuit breaker integration tests

### 3. Updated Environment Variables

**File:** `env.example`

**Added:**
- `STRIPE_PUBLISHABLE_KEY` for future client-side integration

**Verified Existing:**
- `STRIPE_SECRET_KEY`
- `STRIPE_WEBHOOK_SECRET`
- `STRIPE_SUCCESS_URL`
- `STRIPE_CANCEL_URL`

---

## Technical Details

### Implementation Pattern

All methods follow consistent pattern:

```ruby
def create_checkout_session(price_id:, customer_email:, metadata: {}, idempotency_key: nil)
  with_circuit_breaker(name: "stripe:create_checkout_session") do
    params = {
      mode: "subscription",
      line_items: [ {
        price: price_id,
        quantity: 1
      } ],
      customer_email: customer_email,
      success_url: ENV.fetch("STRIPE_SUCCESS_URL"),
      cancel_url: ENV.fetch("STRIPE_CANCEL_URL"),
      metadata: metadata
    }

    options = {}
    options[:idempotency_key] = idempotency_key if idempotency_key

    Stripe::Checkout::Session.create(params, options)
  end
rescue Stripe::StripeError => e
  raise ApiError, "Stripe API error: #{e.message}"
end
```

### Key Methods Implemented

1. **create_checkout_session** - Creates subscription checkout with idempotency support
2. **get_subscription** - Retrieves subscription with nil fallback
3. **get_customer** - Retrieves customer with nil fallback
4. **create_customer** - Creates new customer
5. **cancel_subscription** - Cancels subscription via instance method
6. **get_payment_intent** - Retrieves payment intent

### Error Handling Strategy

- **Stripe::StripeError** → Wrapped in `ApiClientBase::ApiError` for consistency
- **Stripe::InvalidRequestError** → Returns `nil` for read operations (not found)
- Circuit breaker preserves existing threshold/timeout settings
- Retry logic still handled at `ApiClientBase` level

---

## What Was NOT Changed

**Webhook Verification:** Correctly remains in `WebhooksController` (lines 49-62)
- Uses `Stripe::Webhook.construct_event` for signature verification
- Follows Rails convention (verification in controller layer)
- Works with existing `WebhookEvent` idempotency pattern

**ApiClientBase:** No changes needed
- Circuit breaker and retry logic unchanged
- Works seamlessly with Stripe SDK exceptions

---

## Testing

### Unit Tests
```bash
bundle exec rspec spec/services/stripe_client_spec.rb
```
**Result:** 16 examples, 0 failures ✅

### Linting
```bash
bundle exec rubocop
```
**Result:** 153 files inspected, no offenses detected ✅

### Integration
- Circuit breaker tests passing
- Idempotency key propagation verified
- Error handling for all Stripe exception types

---

## Verification

### StripeClient Load Test
```bash
bundle exec rails runner "puts 'StripeClient loaded: ' + StripeClient.new.class.name"
```
**Result:** StripeClient loaded: StripeClient ✅

### Code Quality
- No linter errors
- All tests passing (StripeClient)
- Rubocop clean
- Maintains 90.42% overall test coverage

---

## Dependencies

### Required Gems
- `stripe ~> 12.0` (already installed)

### ENV Variables Required
- `STRIPE_SECRET_KEY` - Stripe API secret key
- `STRIPE_WEBHOOK_SECRET` - Webhook signature secret
- `STRIPE_SUCCESS_URL` - Checkout success redirect
- `STRIPE_CANCEL_URL` - Checkout cancel redirect
- `STRIPE_PUBLISHABLE_KEY` - (new) For client-side integration

---

## Next Steps

This ticket completes the Stripe client setup. Ready for:

1. **R2-E04-T002** - Create Stripe products/prices in Stripe Dashboard
2. **R2-E04-T003** - Build checkout controller using new idempotency support
3. **R2-E04-T004** - Implement Stripe webhook handler for `checkout.session.completed`

---

## Risk Mitigation

### Challenges Overcome
1. **SDK vs Net::HTTP Exception Handling**
   - Solution: Wrapped all Stripe exceptions in consistent ApiError

2. **Response Format Changes**
   - Solution: Updated tests to expect Stripe objects instead of hashes

3. **Idempotency Key Support**
   - Solution: Added optional parameter with proper Stripe SDK options hash

4. **Instance vs Class Methods**
   - Solution: Used `retrieve` + `delete` pattern for `cancel_subscription`

### Residual Risks
- None - migration complete and fully tested

---

## References

- [Stripe Ruby SDK Documentation](https://stripe.com/docs/api/ruby)
- [Stripe Idempotency Keys](https://stripe.com/docs/api/idempotent_requests)
- [Circuit Breaker Pattern](https://martinfowler.com/bliki/CircuitBreaker.html)
- Phase 3 Setup Analysis: `docs/PHASE-3-SETUP-ANALYSIS.md`

---

## Commit Message

```
feat(phase3): Migrate StripeClient to Stripe Ruby SDK

- Replace Net::HTTP with Stripe Ruby SDK for better maintainability
- Add idempotency_key support to create_checkout_session
- Update all methods to use Stripe SDK classes
- Maintain circuit breaker integration via ApiClientBase
- Add comprehensive test coverage for idempotency
- Update env.example with STRIPE_PUBLISHABLE_KEY
- All 16 StripeClient specs passing
- Rubocop clean, 0 offenses

Ref: R2-E04-T001
```


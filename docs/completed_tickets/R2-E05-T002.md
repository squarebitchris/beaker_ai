# R2-E05-T002: Admin - Webhook Event Inspector + Reprocess

**Ticket ID:** R2-E05-T002  
**Epic:** E-005: Live Production  
**Points:** 4  
**Priority:** P0  
**Status:** ✅ Completed  
**Date Completed:** January 2025

---

## Summary

Enhanced the admin webhook event inspector with filtering, PII masking, and reprocess functionality. Admins can now debug webhook issues and recover from failures without SSH access.

## What Was Built

### 1. Filtering Capabilities

Added comprehensive filtering to the webhook event list:

- **Provider filter:** Filter by Stripe, Vapi, or Twilio
- **Status filter:** Filter by pending, processing, completed, or failed
- **Event ID search:** ILIKE search on event_id field
- **100-item limit:** Maintained existing pagination limit

**Files Modified:**
- `app/controllers/admin/webhook_events_controller.rb` - Added filter logic
- `app/views/admin/webhook_events/index.html.erb` - Added filter form UI

### 2. PII Masking

Created a helper module to mask sensitive data in JSON payloads:

- **Email masking:** `john@example.com` → `j***@e***`
- **Phone masking:** `+15551234567` → `***4567`
- **Recursive processing:** Handles nested structures and arrays
- **Applied to show view:** All payloads now display masked PII

**Files Created:**
- `app/helpers/admin/webhook_events_helper.rb` - PII masking logic

**Files Modified:**
- `app/views/admin/webhook_events/show.html.erb` - Applied masking to JSON display

### 3. Reprocess Functionality

Added ability to manually reprocess failed or pending webhook events:

- **Conditional UI:** Reprocess button only appears for failed/pending events
- **Safety warning:** Turbo confirmation dialog before reprocessing
- **State reset:** Clears error message and resets retries counter
- **Job enqueueing:** Re-enqueues WebhookProcessorJob
- **Audit logging:** Logs admin user who triggered reprocess

**Files Modified:**
- `app/controllers/admin/webhook_events_controller.rb` - Added reprocess action
- `config/routes.rb` - Added reprocess member route
- `app/views/admin/webhook_events/show.html.erb` - Added reprocess button

### 4. Retries Display

Added retries count to the webhook event details page:

- Shows format: "Retries X / 3"
- Helps admins understand event processing attempts

**Files Modified:**
- `app/views/admin/webhook_events/show.html.erb` - Added retries field

### 5. Model Scopes

Added helpful query scopes to WebhookEvent model:

- `by_provider(provider)` - Filter by provider
- `by_status(status)` - Filter by status
- `search_event_id(query)` - Search by event_id

**Files Modified:**
- `app/models/webhook_event.rb` - Added scopes

## Technical Implementation

### Controller Changes

```ruby
def index
  @webhook_events = WebhookEvent.order(created_at: :desc)
  
  # Apply filters
  @webhook_events = @webhook_events.where(provider: params[:provider]) if params[:provider].present?
  @webhook_events = @webhook_events.where(status: params[:status]) if params[:status].present?
  @webhook_events = @webhook_events.where("event_id ILIKE ?", "%#{params[:search]}%") if params[:search].present?
  
  @webhook_events = @webhook_events.limit(100)
end

def reprocess
  unless @webhook_event.failed? || @webhook_event.pending?
    redirect_to admin_webhook_event_path(@webhook_event), 
                alert: "Can only reprocess failed or pending events"
    return
  end
  
  @webhook_event.update!(status: 'pending', error_message: nil, retries: 0)
  WebhookProcessorJob.perform_later(@webhook_event.id)
  
  Rails.logger.info("[Admin] Webhook event #{@webhook_event.id} reprocessed by #{current_user.email}")
  
  redirect_to admin_webhook_event_path(@webhook_event), 
              notice: "Event queued for reprocessing"
end
```

### PII Masking Helper

```ruby
def mask_pii_in_json(payload)
  return payload unless payload.is_a?(Hash)
  
  masked = payload.deep_dup
  mask_recursively(masked)
  masked
end

private

def mask_recursively(obj)
  case obj
  when Hash
    obj.each do |key, value|
      if value.is_a?(String)
        obj[key] = mask_sensitive_value(key, value)
      else
        mask_recursively(value)
      end
    end
  when Array
    obj.each { |item| mask_recursively(item) }
  end
end

def mask_sensitive_value(key, value)
  key_str = key.to_s.downcase
  
  # Mask emails
  if key_str.include?('email') && value.match?(/@/)
    parts = value.split('@')
    if parts.length == 2
      local = parts[0]
      domain = parts[1]
      local_masked = "#{local[0]}***"
      domain_masked = "#{domain[0]}***"
      return "#{local_masked}@#{domain_masked}"
    end
    return value
  end
  
  # Mask phone numbers
  if (key_str.include?('phone') || key_str.include?('e164')) && value.match?(/^\+\d/)
    return "***#{value.last(4)}"
  end
  
  value
end
```

## Testing

### Request Specs

Comprehensive coverage for filtering and reprocessing:

- Filter by provider (Stripe, Vapi, Twilio)
- Filter by status (pending, processing, completed, failed)
- Search by event_id
- Reprocess failed events
- Reprocess pending events
- Prevent reprocessing completed events
- Admin-only access enforcement
- Authorization tests for non-admin users

**File:** `spec/requests/admin/webhook_events_spec.rb` - 19 examples, all passing

### Helper Specs

Complete coverage for PII masking:

- Email masking (simple and nested)
- Phone number masking (with e164 and 'phone' key variants)
- Nested structure handling
- Array handling
- Complex nested structures
- Non-hash payload handling
- Non-sensitive data unchanged

**File:** `spec/helpers/admin/webhook_events_helper_spec.rb` - 8 examples, all passing

## Test Results

All new tests passing:
- **27 examples** total (19 request specs + 8 helper specs)
- **0 failures** in new tests
- PII masking working correctly
- Filtering functionality validated
- Reprocess workflow working as expected

## Key Features

### 1. Efficient Filtering

Users can quickly find specific webhook events by:
- Provider (Stripe, Vapi, Twilio)
- Status (pending, processing, completed, failed)
- Event ID substring search

All filters work together and can be combined.

### 2. Privacy Protection

All webhook payloads automatically mask PII:
- **Emails:** `john@example.com` → `j***@e***`
- **Phones:** `+15551234567` → `***4567`

Works recursively through nested JSON structures.

### 3. Operational Recovery

Admins can reprocess failed or stuck webhook events:
- Button only appears for failed/pending events
- Resets status and error message
- Re-enqueues processing job
- Confirmation dialog prevents accidental reprocessing
- Audit trail via Rails.logger

### 4. Clear Feedback

Retries count displayed:
- Shows "Retries X / 3" format
- Helps understand event processing history
- Clear indication when retry limit reached

## UI/UX

### Filter Form

Clean, intuitive filter interface:
- Select dropdowns for provider and status
- Text input for event ID search
- Filter and Reset buttons
- Maintains filter state via URL params

### Reprocess Button

Conditional rendering with warning:
- Yellow background to indicate caution
- Warning message about consequences
- Turbo confirmation dialog
- Only appears for actionable events

### Event Details

Enhanced information display:
- Event ID, Provider, Event Type
- Status with color-coded badges
- Created/Processed timestamps
- Retries count (X / 3)
- Error message (if failed)
- Masked JSON payload

## Files Changed

### Modified Files (8)
1. `app/controllers/admin/webhook_events_controller.rb`
2. `app/views/admin/webhook_events/index.html.erb`
3. `app/views/admin/webhook_events/show.html.erb`
4. `app/models/webhook_event.rb`
5. `config/routes.rb`
6. `spec/requests/admin/webhook_events_spec.rb`
7. `app/helpers/admin/webhook_events_helper.rb` (new)
8. `spec/helpers/admin/webhook_events_helper_spec.rb` (new)

## Lines of Code

- **Controller logic:** ~30 lines
- **Helper logic:** ~50 lines
- **Views:** ~50 lines
- **Model scopes:** ~3 lines
- **Tests:** ~170 lines
- **Total:** ~300 lines of production code

## Acceptance Criteria Met

✅ Filters work for provider, status, and event_id search  
✅ PII (emails, phones) masked in payload display  
✅ Reprocess button appears only for failed/pending events  
✅ Reprocess action enqueues WebhookProcessorJob  
✅ Admin-only access enforced  
✅ Request specs passing for filtering and reprocessing  
✅ Helper specs passing for PII masking  

## Reference Documentation

- **ticket-breakdown.md:** Lines 86-116 (Admin webhook inspector requirements)
- **PHASE-4-SETUP-ANALYSIS.md:** Section on webhook event inspector
- **BUILD-GUIDE.md:** Admin pattern guidelines

## Next Steps

This ticket completes the admin webhook inspector feature. Future enhancements could include:
- Export functionality for webhook events
- Bulk reprocessing
- Advanced search (regex, date range)
- Webhook event analytics

## Notes

- No breaking changes to existing functionality
- Fully backward compatible
- Admin-only features (no impact on end users)
- No database migrations required
- Follows existing Rails and app patterns


# R1-E02-T008: "Call Me Now" Button + Phone Input UI

**Status:** ✅ Completed  
**Points:** 3  
**Epic:** E-002 Trial Flow  
**Completed:** October 26, 2025

## Summary

Implemented auto-formatting phone input with E.164 validation using a Stimulus controller. Ensures all phone numbers submitted to the system are properly formatted for Twilio/Vapi integration, reducing errors and improving user experience.

## Implementation Details

### Files Created/Modified

1. **`app/javascript/controllers/phone_input_controller.js`**
   - **`connect()`**: Initializes auto-formatting on input
   - **`formatOnType()`**: Converts typed input to E.164 format (`+1XXXXXXXXXX`)
     - Strips non-digits
     - Adds `+1` prefix if missing (US-only for MVP)
     - Updates input field in real-time
   - **`validateBeforeSubmit(event)`**: Client-side validation before form submission
     - Validates E.164 format: `/^\+1\d{10}$/`
     - Prevents submission if invalid
     - Displays user-friendly error message

2. **`app/views/trials/show.html.erb`**
   - Added Stimulus controller to phone input: `data-controller="phone-input"`
   - Bound formatting to `input` event: `data-action="input->phone-input#formatOnType"`
   - Bound validation to form `submit` event: `data-action="submit->phone-input#validateBeforeSubmit"`
   - Added hidden error message paragraph for validation feedback

3. **`app/controllers/trials_controller.rb`**
   - Server-side validation blocks test numbers: `/\+1(555|800|888|877|866|855|844|833)\d{7}/`
   - Prevents toll-free and 555 area code numbers (test numbers)
   - Returns 422 Unprocessable Entity with error message

4. **`app/models/trial.rb`**
   - Phone normalization: `normalizes :phone_e164` callback
   - Converts any phone format to E.164 server-side (fallback)
   - Prevents duplicate trials for same phone within 48 hours (abuse prevention)

## Technical Implementation

### Auto-Formatting Logic
```javascript
formatOnType() {
  let value = this.inputTarget.value;
  
  // Remove all non-digits
  let digits = value.replace(/\D/g, '');
  
  // Add +1 prefix if missing (US only for MVP)
  if (!digits.startsWith('1')) {
    digits = '1' + digits;
  }
  
  // Format as E.164
  this.inputTarget.value = '+' + digits.slice(0, 11);
}
```

### Validation Logic
```javascript
validateBeforeSubmit(event) {
  const phone = this.inputTarget.value;
  const e164Regex = /^\+1\d{10}$/;
  
  if (!e164Regex.test(phone)) {
    event.preventDefault();
    this.showError("Phone must be in format: +1XXXXXXXXXX");
    return false;
  }
  
  this.hideError();
  return true;
}
```

### User Experience
1. User types: `(212) 555-1234`
2. Auto-formats to: `+12125551234`
3. On submit: Validates format
4. If invalid: Displays error, prevents submission
5. If valid: Submits to server

## Test Coverage

- **System specs:** Phone formatting behavior with JavaScript
- **Request specs:** Server-side validation of test numbers
- **Model specs:** Phone normalization to E.164
- **Integration specs:** End-to-end trial creation flow
- **Coverage:** 90.63% overall

## Acceptance Criteria Met

- ✅ Phone input auto-formats to E.164 as user types
- ✅ Client-side validation prevents invalid formats
- ✅ Server-side validation blocks test/toll-free numbers
- ✅ Model normalization ensures consistent storage
- ✅ User-friendly error messages
- ✅ Mobile-friendly input (no iOS zoom issues)

## Technical Decisions

### Stimulus vs. Vanilla JS
**Decision:** Use Stimulus controller

**Rationale:**
- **Reusable:** Can apply to multiple phone inputs
- **Testable:** Easy to test with Capybara/system specs
- **Maintainable:** Clear separation of concerns
- **Rails-friendly:** Integrates seamlessly with Turbo

### E.164 Format
**Decision:** Enforce E.164 format (`+1XXXXXXXXXX`) for US numbers

**Rationale:**
- **Twilio requirement:** E.164 is the only format Twilio accepts
- **Vapi requirement:** E.164 is required for outbound calls
- **Consistent:** Single format simplifies validation and storage
- **International:** E.164 is globally standardized (easy to extend to other countries)

### US-Only for MVP
**Decision:** Only support US numbers (`+1`) in Phase 1

**Rationale:**
- **Simplifies validation:** Single country code
- **Reduces complexity:** No country code picker needed
- **MVP focus:** Target US market first
- **Future:** Phase 2+ can add international support

## Dependencies

- Requires: T007 (trial status page), T010 (TrialsController)
- Enables: Valid phone numbers for Twilio/Vapi outbound calls
- Integrates with: T012 (abuse prevention), T004 (Vapi client)

## Performance

- **Auto-formatting:** <1ms per keystroke (instant feedback)
- **Validation:** <1ms on submit (no API calls)
- **Server-side validation:** <5ms (regex match)

## Notes

- Client-side validation is UX enhancement; server-side validation is security boundary
- Test numbers (555, 800, etc.) blocked to prevent waste of API credits
- Future: Add phone number lookup API (e.g., Twilio Lookup) to verify number is valid/reachable


# R2-E05-T001: Admin Panel Base Interface

**Epic:** E-005: Live Production  
**Points:** 5  
**Priority:** P0 - CRITICAL (ships first)  
**Status:** ✅ COMPLETED  
**Date:** January 26, 2025

---

## Overview

Implemented R2-E05-T001: Admin Panel Base Interface, which creates a gated admin interface accessible only to users with `admin=true`. This provides critical debugging capabilities without SSH access - a fundamental requirement before launching Phase 4 paid features.

## Context & Why It Matters

Before Phase 4 paid features can launch, we need operational tools to debug issues without SSH access. The admin panel enables:

- Inspecting webhook events in real-time
- Viewing business and user data
- Monitoring system health
- Debugging conversion issues

This is marked as CRITICAL and ships FIRST before any other Phase 4 work.

## Implementation

### Files Created (17 total)

**Controllers (5):**
- `app/controllers/admin/base_controller.rb` - Base controller with admin authentication guard
- `app/controllers/admin/dashboard_controller.rb` - Dashboard with system stats
- `app/controllers/admin/webhook_events_controller.rb` - Webhook event management
- `app/controllers/admin/businesses_controller.rb` - Business management
- `app/controllers/admin/users_controller.rb` - User management

**Views (8):**
- `app/views/layouts/admin.html.erb` - Admin layout with sidebar navigation
- `app/views/admin/dashboard/index.html.erb` - Dashboard view with metrics
- `app/views/admin/webhook_events/index.html.erb` - Webhook events list
- `app/views/admin/webhook_events/show.html.erb` - Webhook event details
- `app/views/admin/businesses/index.html.erb` - Businesses list
- `app/views/admin/businesses/show.html.erb` - Business details
- `app/views/admin/users/index.html.erb` - Users list
- `app/views/admin/users/show.html.erb` - User details

**Tests (4):**
- `spec/requests/admin/base_controller_spec.rb` - Authentication tests
- `spec/requests/admin/webhook_events_spec.rb` - Webhook events CRUD tests
- `spec/requests/admin/businesses_spec.rb` - Businesses CRUD tests
- `spec/requests/admin/users_spec.rb` - Users CRUD tests

### Files Modified (2)

1. **`app/models/user.rb`** - Added `admin?` helper method
2. **`config/routes.rb`** - Added admin namespace with protected routes

### Key Features Implemented

#### 1. Admin Authentication
- Base controller requires authentication AND admin flag
- Non-admins redirected to root with "Access denied" alert
- Uses `user.admin?` helper method
- All routes protected at controller level

#### 2. Dashboard
- Shows webhook events today count
- Displays total businesses count
- Displays total users count
- Quick links to all admin sections

#### 3. Webhook Events Inspector
- Lists last 100 webhook events
- Shows provider, event type, status, timestamps
- Detailed view with full JSON payload (pretty-printed)
- Status badges (completed/failed/pending/processing)

#### 4. Businesses Management
- Lists 50 most recent businesses
- Shows plan, status, calls used/included
- Details view with Stripe customer/subscription IDs
- Shows associated owners with links

#### 5. Users Management
- Lists 50 most recent users
- Shows admin badge for admin users
- Displays trials count
- Details view with trials and businesses linked

#### 6. Sidebar Navigation
- Dark themed sidebar (gray-900 background)
- Active route highlighting
- Links to Dashboard, Webhook Events, Businesses, Users
- External link to Sidekiq UI

### Security Implementation

- **Authentication:** All admin routes require `authenticate_user!`
- **Authorization:** Additional check for `user.admin?` flag
- **Redirect Strategy:** Uses `redirect_to root_path` with alert (not 403) to avoid revealing admin paths exist
- **Helper Method:** Added `admin?` to User model for clear boolean check

### UI/UX Implementation

- **Layout:** Clean sidebar + main content area design
- **Styling:** Tailwind CSS for responsive, modern design
- **Tables:** Responsive data tables with proper styling
- **Navigation:** Active route highlighting for better UX
- **Details Pages:** Comprehensive information display with labeled sections

## Test Coverage

**All 30 admin tests passing:**
- Base controller authentication guards (4 tests)
- Webhook events CRUD operations (8 tests)
- Businesses CRUD operations (8 tests)
- Users CRUD operations (10 tests)

### Test Scenarios Verified

✅ Non-authenticated users redirected to sign in  
✅ Non-admin users get redirected with "Access denied" alert  
✅ Admin users can access all admin pages  
✅ Data displays correctly in all views  
✅ Access control enforced at controller level  

### Linting

- All 18 RuboCop offenses auto-corrected
- No linting errors remain
- Code follows project style guidelines

## Acceptance Criteria - Met

✅ Non-admin cannot access `/admin/*` routes (redirect with alert)  
✅ Admin can view webhook events list and details  
✅ Admin can view businesses list and details  
✅ Admin can view users list and details  
✅ Admin layout has working navigation  
✅ All routes protected with authentication + admin check  
✅ Tests verify access control works correctly  

## Technical Notes

### Architecture Decisions

1. **Base Controller Pattern:** All admin controllers inherit from `Admin::BaseController` for shared authentication logic
2. **Route Protection:** Authentication + authorization enforced at controller level, not routes
3. **Sidebar Navigation:** Server-side highlighted active routes using `request.path`
4. **JSON Display:** Uses `JSON.pretty_generate` for readable webhook payloads
5. **Lists Limits:** Index actions limit results (100 webhooks, 50 businesses, 50 users) for performance

### Database Indexes

The admin functionality leverages existing indexes:
- `index_users_on_admin` (partial index on admin=true)
- Proper foreign key indexes on all relationships

### Future Enhancements

The following features are NOT in scope for this ticket (deferred to R2-E05-T002 and T003):

- Webhook event filtering and search
- JSON syntax highlighting
- PII masking in payloads
- Entity search (Business/User/Lead)
- Webhook event reprocessing

These are planned for subsequent tickets.

## Files Changed Summary

**Created:** 17 files (5 controllers, 8 views, 4 test files)  
**Modified:** 2 files (user.rb, routes.rb)  
**Lines Added:** ~1,200 lines of code  
**Lines Modified:** ~10 lines  

## Next Steps

After completing this ticket, proceed with:

1. **R2-E05-T002** - Webhook event inspector with advanced filtering and JSON viewer enhancements
2. **R2-E05-T003** - Entity search functionality for cross-model searching

These tickets build upon the base admin infrastructure created here.

## References

- Original Plan: `docs/ticket-breakdown.md` Section R2-E05-T001
- Related Tickets: R2-E05-T002, R2-E05-T003
- Admin Route Path: `/admin` (namespace)
- Sidekiq UI: Already protected with `user.admin?`

